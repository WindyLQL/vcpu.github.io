<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="vcpu" />





  <link rel="alternate" href="/atom.xml" title="i博客" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta property="og:type" content="website">
<meta property="og:title" content="i博客">
<meta property="og:url" content="http://vcpu.me/page/2/index.html">
<meta property="og:site_name" content="i博客">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="i博客">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 'undefined',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://vcpu.me/page/2/"/>





  <title>i博客</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">i博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">仰望星空前，还需脚踏实地。</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            站点地图
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://vcpu.me/policy_router/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="vcpu.me">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/h.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="i博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/policy_router/" itemprop="url">linux策略路由的添加</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-13T18:00:00+08:00">
                2018-05-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/网络/" itemprop="url" rel="index">
                    <span itemprop="name">网络</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/policy_router/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="policy_router/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/policy_router/" class="leancloud_visitors" data-flag-title="linux策略路由的添加">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="添加记录"><a href="#添加记录" class="headerlink" title="添加记录"></a>添加记录</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">stack@pdf-compute:~$ ip rule show</span><br><span class="line"><span class="number">0</span>:	<span class="keyword">from</span> all lookup local</span><br><span class="line"><span class="number">32765</span>:	<span class="keyword">from</span> <span class="number">169.254</span><span class="number">.169</span><span class="number">.254</span> lookup <span class="number">2</span></span><br><span class="line"><span class="number">32766</span>:	<span class="keyword">from</span> all lookup main</span><br><span class="line"><span class="number">32767</span>:	<span class="keyword">from</span> all lookup default</span><br><span class="line">stack@pdf-compute:~$</span><br><span class="line">stack@pdf-compute:~$ sudo ip rule add <span class="keyword">from</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.0</span>/<span class="number">24</span> table <span class="number">10</span></span><br><span class="line">stack@pdf-compute:~$ sudo ip route add default via <span class="number">192.168</span><span class="number">.56</span><span class="number">.10</span> table <span class="number">10</span></span><br><span class="line">RTNETLINK answers: File exists</span><br><span class="line">stack@pdf-compute:~$ ip route show table <span class="number">10</span></span><br><span class="line">default via <span class="number">192.168</span><span class="number">.56</span><span class="number">.10</span> dev br-ex</span><br><span class="line">stack@pdf-compute:~$</span><br><span class="line">stack@pdf-compute:~$ sudo ip route delete  default via <span class="number">192.168</span><span class="number">.56</span><span class="number">.10</span> table <span class="number">10</span></span><br><span class="line">stack@pdf-compute:~$ ip route show table <span class="number">10</span></span><br><span class="line">stack@pdf-compute:~$</span><br><span class="line">stack@pdf-compute:~$ sudo ip route add default via <span class="number">192.168</span><span class="number">.56</span><span class="number">.10</span> table <span class="number">10</span></span><br><span class="line">stack@pdf-compute:~$</span><br><span class="line">stack@pdf-compute:~$ ip route show table <span class="number">10</span></span><br><span class="line">default via <span class="number">192.168</span><span class="number">.56</span><span class="number">.10</span> dev br-ex</span><br><span class="line">stack@pdf-compute:~$ sudo ip route add <span class="number">114.114</span><span class="number">.114</span><span class="number">.114</span>  via <span class="number">192.168</span><span class="number">.56</span><span class="number">.10</span> table <span class="number">10</span></span><br><span class="line">stack@pdf-compute:~$ ip route show table <span class="number">10</span></span><br><span class="line">default via <span class="number">192.168</span><span class="number">.56</span><span class="number">.10</span> dev br-ex</span><br><span class="line"><span class="number">114.114</span><span class="number">.114</span><span class="number">.114</span> via <span class="number">192.168</span><span class="number">.56</span><span class="number">.10</span> dev br-ex</span><br></pre></td></tr></table></figure>
<h1 id="步骤总结"><a href="#步骤总结" class="headerlink" title="步骤总结"></a>步骤总结</h1><h2 id="添加"><a href="#添加" class="headerlink" title="添加"></a>添加</h2><ul>
<li>ip rule add from 192.168.56.0/24 table 10</li>
<li>ip route add default via 192.168.56.10 table 10</li>
<li>ip route add 114.114.114.114 via 192.168.56.10 table 10</li>
</ul>
<h2 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h2><ul>
<li>ip route delete 114.114.114.114 via 192.168.56.10 table 10</li>
<li>sudo ip route delete default via 192.168.56.10 table 10</li>
<li>sudo ip rule delete from 192.168.56.0/24</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://vcpu.me/conjuctive/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="vcpu.me">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/h.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="i博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/conjuctive/" itemprop="url">CONJUNCTIVE MATCH FIELDS原理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-08T18:00:00+08:00">
                2018-05-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/网络/" itemprop="url" rel="index">
                    <span itemprop="name">网络</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/conjuctive/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="conjuctive/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/conjuctive/" class="leancloud_visitors" data-flag-title="CONJUNCTIVE MATCH FIELDS原理">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="问题？"><a href="#问题？" class="headerlink" title="问题？"></a>问题？</h1><p>一条单独的openflow的字段只能匹配一个条件，但是总会有需要匹配多个条件的使用场景。</p>
<p>为了匹配一组字段可以通过多加对应个数的流表来实现，当然这是最简单高效的方法。</p>
<p>eg: 把原地址是a，b，c，d发给控制器处理，你可以通过如下多条流表实现：</p>
<p> ip,ip_src=a actions=controller</p>
<p> ip,ip_src=b actions=controller</p>
<p> ip,ip_src=c actions=controller</p>
<p> ip,ip_src=d actions=controller</p>
<p>当然和其相识的场景如下，e,f,g,h的目的地址的发给控制器处理</p>
<p> ip,ip_dst=e actions=controller</p>
<p> ip,ip_dst=f actions=controller</p>
<p> ip,ip_dst=g actions=controller</p>
<p> ip,ip_dst=h actions=controller</p>
<p>但是问题来了，你把上述两种情况流表，都放到一个table中，就会出现问题：</p>
<p>当前情况是，如果源ip是a,b,c,d，目的ip是e,f,g,h；或者两个条件只要满足一个，数据包就被发给controller处理</p>
<p>很显然，上述流表可能命中多个，一般来讲出现这种情况需要优先级概念来区分查找到精确的流表，否则优先级别全部相同情况下，命中策略就是不稳定性的</p>
<p>也不知道会命中哪一条策略。</p>
<p>假定，如果想要连续匹配，源地址和目的地址必须分别在abcd和efgh中选取，那么共有16总流表来实现此需求，当然我们举例的场景使用这种方法不会别扭，但是如果情况更复杂？</p>
<p>综上所述，conjunction就诞生了（ovs2.4+支持）</p>
<h1 id="如何实现的？"><a href="#如何实现的？" class="headerlink" title="如何实现的？"></a>如何实现的？</h1><h2 id="32-bit-id-for-conjunctive"><a href="#32-bit-id-for-conjunctive" class="headerlink" title="32-bit id for conjunctive "></a>32-bit id for conjunctive </h2><p>32位的id是openflow table中具有唯一性</p>
<h2 id="如何实现的？-1"><a href="#如何实现的？-1" class="headerlink" title="如何实现的？"></a>如何实现的？</h2><p>首先根据conjunction ID找到第一条流表，然后，查找对应conjunction 匹配集合；conjunction(id, k/n)来表示，其中id为conjunction ID ，k是dimension的编号，n是dimension 总数</p>
<p>那么怎么样算是满足条件？n个dimension集合中，每一个集合必须有一个满足；这样必须有n个条件满足才算这个conjunction 满足情况，进行相应的动作执行。</p>
<p>eg:</p>
<p>conj_id=1234 actions=controller<br>                 ip,ip_src=10.0.0.1 actions=conjunction(1234, 1/2)<br>                 ip,ip_src=10.0.0.4 actions=conjunction(1234, 1/2)<br>                 ip,ip_src=10.0.0.6 actions=conjunction(1234, 1/2)<br>                 ip,ip_src=10.0.0.7 actions=conjunction(1234, 1/2)<br>                 ip,ip_dst=10.0.0.2 actions=conjunction(1234, 2/2)<br>                 ip,ip_dst=10.0.0.5 actions=conjunction(1234, 2/2)<br>                 ip,ip_dst=10.0.0.7 actions=conjunction(1234, 2/2)<br>                 ip,ip_dst=10.0.0.8 actions=conjunction(1234, 2/2)</p>
<pre><code>两个条件，源IP（dimension 1 of2）和目的IP（dimension 2 of 2）同时满足的写法；假设有如下流量模型：

a. src ip 10.0.0.1 dst ip 114.114.114.114 

b. src ip 10.0.0.7 dst ip 10.0.0.8

c. src ip 10.0.0.8 dst ip 10.0.0.1

d. src ip 1.1.1.1 dst ip 2.2.2.2 

上述abcd四个选项，只有b是满足条件的，可以执行actions=controller（将数据包发给控制器）
</code></pre>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://vcpu.me/build_ovs/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="vcpu.me">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/h.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="i博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/build_ovs/" itemprop="url">openvswitch手动编译方法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-28T18:00:00+08:00">
                2018-04-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/build_ovs/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="build_ovs/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/build_ovs/" class="leancloud_visitors" data-flag-title="openvswitch手动编译方法">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="手动编译"><a href="#手动编译" class="headerlink" title="手动编译"></a>手动编译</h1><p>编译环境：Linux ubuntu 4.4.0-87-generic</p>
<h2 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt-get update</span><br><span class="line">apt-get install -y dh-autoreconf libssl-dev libcap-ng-dev openssl python python-pip</span><br><span class="line">pip install six</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http://openvswitch.org/releases/openvswitch<span class="number">-2.7</span><span class="number">.0</span>.tar.gz</span><br><span class="line">tar zxvf openvswitch<span class="number">-2.7</span><span class="number">.0</span>.tar.gz &amp;&amp; cd openvswitch<span class="number">-2.7</span><span class="number">.0</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./boot.sh</span><br><span class="line">./configure --<span class="keyword">with</span>-linux=/lib/modules/$(uname -r)/build</span><br><span class="line">make -j</span><br><span class="line">make install</span><br><span class="line">make modules_install</span><br></pre></td></tr></table></figure>
<h2 id="加载启动服务"><a href="#加载启动服务" class="headerlink" title="加载启动服务"></a>加载启动服务</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/sbin/modprobe openvswitch</span><br><span class="line">mkdir -p /usr/local/etc/openvswitch</span><br><span class="line">ovsdb-tool create /usr/local/etc/openvswitch/conf.db vswitchd/vswitch.ovsschema</span><br><span class="line">mkdir -p /usr/local/var/run/openvswitch</span><br><span class="line">mkdir -p /usr/local/var/log/openvswitch</span><br><span class="line">ovsdb-server --remote=punix:/usr/local/var/run/openvswitch/db.sock --remote=db:Open_vSwitch,Open_vSwitch,manager_options --pidfile --detach --log-file</span><br><span class="line">ovs-vsctl --no-wait init</span><br><span class="line">ovs-vswitchd --pidfile --detach --log-file</span><br><span class="line">export PATH=$PATH:/usr/local/share/openvswitch/scripts</span><br><span class="line">ovs-ctl start</span><br></pre></td></tr></table></figure>
<h2 id="停止服务"><a href="#停止服务" class="headerlink" title="停止服务"></a>停止服务</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kill `cd /usr/local/var/run/openvswitch &amp;&amp; cat ovsdb-server.pid ovs-vswitchd.pid`</span><br><span class="line">export PATH=$PATH:/usr/local/share/openvswitch/scripts</span><br><span class="line">ovs-ctl stop</span><br></pre></td></tr></table></figure>
<h2 id="开启服务"><a href="#开启服务" class="headerlink" title="开启服务"></a>开启服务</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ovsdb-server --remote=punix:/usr/local/var/run/openvswitch/db.sock --remote=db:Open_vSwitch,Open_vSwitch,manager_options --pidfile --detach --log-file</span><br><span class="line">ovs-vswitchd --pidfile --detach --log-file</span><br><span class="line">export PATH=$PATH:/usr/local/share/openvswitch/scripts</span><br><span class="line">ovs-ctl start</span><br></pre></td></tr></table></figure>
<h1 id="编译deb数据包"><a href="#编译deb数据包" class="headerlink" title="编译deb数据包"></a>编译deb数据包</h1><p>使用此方法在4.4.0-87-generic系统下编译openvswitch-2.6.1 、openvswitch-2.7.0和 openvswitch-2.8.0</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">apt-get install build-essential fakeroot</span><br><span class="line">dpkg-checkbuilddeps</span><br><span class="line"><span class="comment"># 已经编译过，需要首先clean</span></span><br><span class="line"><span class="comment"># fakeroot debian/rules clean</span></span><br><span class="line">DEB_BUILD_OPTIONS=<span class="string">'parallel=8 nocheck'</span> fakeroot debian/rules binary</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://vcpu.me/ovs_connection_crach/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="vcpu.me">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/h.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="i博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/ovs_connection_crach/" itemprop="url">两台云主机处于同一个物理主机的fip和安全组会话冲突</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-23T18:00:00+08:00">
                2018-04-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/ovs_connection_crach/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="ovs_connection_crach/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/ovs_connection_crach/" class="leancloud_visitors" data-flag-title="两台云主机处于同一个物理主机的fip和安全组会话冲突">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="问题描述："><a href="#问题描述：" class="headerlink" title="问题描述："></a>问题描述：</h1><p>在开启安全组情况下，同物理机器上同一个br-int两个绑定fip的云主机icmp通信 时通时不通，TCP协议通信始终没有无法连通</p>
<h1 id="模拟的脚本"><a href="#模拟的脚本" class="headerlink" title="模拟的脚本"></a>模拟的脚本</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Creating ns1 with IP 10.100.5.8(FIP 192.168.56.31, Mac fa:16:3e:00:eb:c0)</span></span><br><span class="line">sudo ip netns add ns1</span><br><span class="line">sudo ovs-vsctl add-br test0</span><br><span class="line">sudo ip link add vns1 type veth peer name vpeerns1</span><br><span class="line">sudo ip link set vpeerns1 netns ns1</span><br><span class="line">sudo ip link set vns1 up</span><br><span class="line">sudo ip netns <span class="keyword">exec</span> ns1 ip link set vpeerns1 address fa:<span class="number">16</span>:<span class="number">3</span>e:<span class="number">1</span>d:<span class="number">3</span>d:<span class="number">01</span></span><br><span class="line">sudo ip netns <span class="keyword">exec</span> ns1 ip addr add dev vpeerns1 <span class="number">10.100</span><span class="number">.5</span><span class="number">.8</span>/<span class="number">24</span></span><br><span class="line">sudo ip netns <span class="keyword">exec</span> ns1 ip link set vpeerns1 up</span><br><span class="line">sudo ip netns <span class="keyword">exec</span> ns1 ip route add default via <span class="number">10.100</span><span class="number">.5</span><span class="number">.1</span></span><br><span class="line">sudo ovs-vsctl add-port test0 vns1</span><br><span class="line"></span><br><span class="line"><span class="comment">#Creating ns2 with IP 10.100.5.9 Mac fa:16:3e:13:85:be(FIP 192.168.56.32, Mac fa:16:3e:71:b6:6e)</span></span><br><span class="line">sudo ip netns add ns2</span><br><span class="line">sudo ip link add vns2 type veth peer name vpeerns2</span><br><span class="line">sudo ip link set vpeerns2 netns ns2</span><br><span class="line">sudo ip link set vns2 up</span><br><span class="line">sudo ip netns <span class="keyword">exec</span> ns2 ip link set vpeerns2 address fa:<span class="number">16</span>:<span class="number">3</span>e:<span class="number">13</span>:<span class="number">85</span>:be</span><br><span class="line">sudo ip netns <span class="keyword">exec</span> ns2 ip addr add dev vpeerns2 <span class="number">10.100</span><span class="number">.5</span><span class="number">.9</span>/<span class="number">24</span></span><br><span class="line">sudo ip netns <span class="keyword">exec</span> ns2 ip link set vpeerns2 up</span><br><span class="line">sudo ip netns <span class="keyword">exec</span> ns2 ip route add default via <span class="number">10.100</span><span class="number">.5</span><span class="number">.1</span></span><br><span class="line">sudo ovs-vsctl add-port test0 vns2</span><br><span class="line"></span><br><span class="line"><span class="comment">#Dispatcher Table</span></span><br><span class="line">sudo ovs-ofctl -v -O OpenFlow13 add-flow test0 <span class="string">"table=0,priority=10,in_port=1,ip,actions=goto_table=40"</span></span><br><span class="line">sudo ovs-ofctl -v -O OpenFlow13 add-flow test0 <span class="string">"table=0,priority=10,in_port=2,ip,actions=goto_table=40"</span></span><br><span class="line">sudo ovs-ofctl -v -O OpenFlow13 add-flow test0 <span class="string">"table=0,priority=42,arp,actions=goto_table=81"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#L3 and Floating Ip Conversion(Router IP 10.100.5.1 Mac fa:16:3e:57:f2:9a)</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=21,priority=42,ip,nw_dst=10.100.5.9 actions=resubmit(,251)"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=21,priority=42,ip,nw_dst=10.100.5.8 actions=resubmit(,251)"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=21,priority=42,ip,nw_dst=192.168.56.31 actions=set_field:fa:16:3e:00:eb:c0-&gt;eth_dst,goto_table:25"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=21,priority=42,ip,nw_dst=192.168.56.32 actions=set_field:fa:16:3e:71:b6:6e-&gt;eth_dst,goto_table:25"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=25,priority=10,ip,dl_dst=fa:16:3e:00:eb:c0,nw_dst=192.168.56.31 actions=set_field:10.100.5.8-&gt;ip_dst,set_field:fa:16:3e:57:f2:9a-&gt;eth_src,set_field:fa:16:3e:1d:3d:01-&gt;eth_dst,goto_table:26"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=25,priority=10,ip,dl_dst=fa:16:3e:71:b6:6e,nw_dst=192.168.56.32 actions=set_field:10.100.5.9-&gt;ip_dst,set_field:fa:16:3e:57:f2:9a-&gt;eth_src,set_field:fa:16:3e:13:85:be-&gt;eth_dst,goto_table:26"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=26,priority=10,ip,nw_src=10.100.5.8 actions=set_field:192.168.56.31-&gt;ip_src,goto_table:28"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=26,priority=10,ip,nw_src=10.100.5.9 actions=set_field:192.168.56.32-&gt;ip_src,goto_table:28"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=27,priority=10,ip,nw_dst=10.100.5.8 actions=resubmit(,21)"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=27,priority=10,ip,nw_dst=10.100.5.9 actions=resubmit(,21)"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=28,priority=10,ip,nw_src=192.168.56.31 actions=set_field:fa:16:3e:00:eb:c0-&gt;eth_src,resubmit(,21)"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=28,priority=10,ip,nw_src=192.168.56.32 actions=set_field:fa:16:3e:71:b6:6e-&gt;eth_src,resubmit(,21)"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ACL ruless egress from vm</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=40,priority=61010,ip,dl_src=fa:16:3e:1d:3d:01,nw_src=10.100.5.8,actions=ct(table=41,zone=5002)"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=40,priority=61010,ip,dl_src=fa:16:3e:13:85:be,nw_src=10.100.5.9,actions=ct(table=41,zone=5002)"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=40,priority=0,actions=drop"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=41,priority=62020,ct_state=-new+est-rel-inv+trk,actions=resubmit(,21)"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=41,priority=62020,ct_state=-new-est+rel-inv+trk,actions=resubmit(,21)"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=41,priority=62020,ct_state=+inv+trk,actions=drop"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=41,priority=1000,ct_state=+new+trk,ip,dl_src=fa:16:3e:1d:3d:01,nw_src=10.100.5.8,actions=ct(commit,zone=5002),resubmit(,21)"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=41,priority=1000,ct_state=+new+trk,ip,dl_src=fa:16:3e:13:85:be,nw_src=10.100.5.9,actions=ct(commit,zone=5002),resubmit(,21)"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=41,priority=50,ct_state=+new+trk,actions=drop"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=41,priority=0,actions=drop"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ARP responder</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=81,priority=100,arp,arp_tpa=192.168.56.31,arp_op=1 actions=move:NXM_OF_ETH_SRC[]-&gt;NXM_OF_ETH_DST[],set_field:fa:16:3e:00:eb:c0-&gt;eth_src,load:0x2-&gt;NXM_OF_ARP_OP[],move:NXM_NX_ARP_SHA[]-&gt;NXM_NX_ARP_THA[],move:NXM_OF_ARP_SPA[]-&gt;NXM_OF_ARP_TPA[],load:0xfa163e00ebc0-&gt;NXM_NX_ARP_SHA[],load:0xc0a8381f-&gt;NXM_OF_ARP_SPA[],load:0-&gt;NXM_OF_IN_PORT[],load:0x500-&gt;NXM_NX_REG6[],write_metadata:0/0x1,goto_table:220"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=81,priority=100,arp,arp_tpa=192.168.56.32,arp_op=1 actions=move:NXM_OF_ETH_SRC[]-&gt;NXM_OF_ETH_DST[],set_field:fa:16:3e:71:b6:6e-&gt;eth_src,load:0x2-&gt;NXM_OF_ARP_OP[],move:NXM_NX_ARP_SHA[]-&gt;NXM_NX_ARP_THA[],move:NXM_OF_ARP_SPA[]-&gt;NXM_OF_ARP_TPA[],load:0xfa163e71b66e-&gt;NXM_NX_ARP_SHA[],load:0xc0a83820-&gt;NXM_OF_ARP_SPA[],load:0-&gt;NXM_OF_IN_PORT[],load:0x500-&gt;NXM_NX_REG6[],write_metadata:0/0x1,goto_table:220"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=81,arp,arp_tpa=10.100.5.1,arp_op=1 actions=move:NXM_OF_ETH_SRC[]-&gt;NXM_OF_ETH_DST[],set_field:fa:16:3e:57:f2:9a-&gt;eth_src,load:0x2-&gt;NXM_OF_ARP_OP[],move:NXM_NX_ARP_SHA[]-&gt;NXM_NX_ARP_THA[],move:NXM_OF_ARP_SPA[]-&gt;NXM_OF_ARP_TPA[],load:0xfa163e7c661a-&gt;NXM_NX_ARP_SHA[],load:0xa640501-&gt;NXM_OF_ARP_SPA[],load:0-&gt;NXM_OF_IN_PORT[],load:0x100-&gt;NXM_NX_REG6[],resubmit(,220)"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=81,priority=10,arp,actions=NORMAL"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Dispatcher Table</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=220,priority=62020,ip,dl_dst=fa:16:3e:1d:3d:01,nw_dst=10.100.5.8,actions=output:1"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=220,priority=62020,ip,dl_dst=fa:16:3e:13:85:be,nw_dst=10.100.5.9,actions=output:2"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=220,priority=62020,arp,dl_dst=fa:16:3e:1d:3d:01,actions=output:1"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=220,priority=62020,arp,dl_dst=fa:16:3e:13:85:be,actions=output:2"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ACL ruless ingress to vm</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=251,priority=61010,ip,dl_dst=fa:16:3e:1d:3d:01,nw_dst=10.100.5.8,actions=ct(table=252,zone=5002)"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=251,priority=61010,ip,dl_dst=fa:16:3e:13:85:be,nw_dst=10.100.5.9,actions=ct(table=252,zone=5002)"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=251,priority=0,actions=drop"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=252,priority=62020,ct_state=-new+est-rel-inv+trk,actions=resubmit(,220)"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=252,priority=62020,ct_state=-new-est+rel-inv+trk,actions=resubmit(,220)"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=252,priority=62020,ct_state=+inv+trk,actions=drop"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=252,priority=50,ct_state=+new+trk,actions=drop"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=252,priority=1000,ct_state=+new+trk,ip,dl_dst=fa:16:3e:1d:3d:01,nw_dst=10.100.5.8,actions=ct(commit,zone=5002),resubmit(,220)"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=252,priority=1000,ct_state=+new+trk,ip,dl_dst=fa:16:3e:13:85:be,nw_dst=10.100.5.9,actions=ct(commit,zone=5002),resubmit(,220)"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=252,priority=0,actions=drop"</span></span><br></pre></td></tr></table></figure>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>通过观察流量路径发现，数据包在table15被丢弃，table15是出方向安全组。详细说明如下</p>
<p>eg： 云主机A fip为FIPA 和云主机B fip为FIPB icmp通信</p>
<p>云主机A icmp request数据包可以到达云主机B</p>
<p>云主机B回复该数据包，经过B的出方向安全组模块时候被丢弃,计数如下流表所示</p>
<p> cookie=0x0, duration=1154.456s, table=15, n_packets=0, n_bytes=0, idle_age=18019, priority=65534,ct_state=+inv+trk actions=drop</p>
<p>云主机B回复的数据包被当成异常状态，该数据包被丢弃</p>
<p>另从linux conntrack 会话角度分析问题如下：</p>
<p>conntrack -L查看会话</p>
<p>icmp 1 29 src=7.7.7.11 dst=192.168.210.17 type=8 code=0 id=31233 [UNREPLIED] src=192.168.210.17 dst=7.7.7.11 type=0 code=0 id=31233 mark=0 zone=7 use=1</p>
<p>只有正向会话，缺少源地址和目的地址转换后的会话，所以，云主机B reply数据包因查不到会话而认为该数据包异常状态，将reply丢弃</p>
<p>那么问题可以归纳为，在同一个云主机的两个绑定同网断fip通信，且用流表实现安全组功能时，icmp协议通信时候，fip 转换后的会话建立异常（icmp有时候能建立，TCP一直建立不了），导致云主机连通访问失败</p>
<h1 id="解决办法："><a href="#解决办法：" class="headerlink" title="解决办法："></a>解决办法：</h1><p>将这两个会话放到不通的ct中问题可解决，具体操作是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=40,priority=61011,ip,dl_src=fa:16:3e:1d:3d:01,nw_src=10.100.5.8,actions=ct(table=41,zone=5001)"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=40,priority=61011,ip,dl_src=fa:16:3e:13:85:be,nw_src=10.100.5.9,actions=ct(table=41,zone=5002)"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=41,priority=1001,ct_state=+new+trk,ip,dl_src=fa:16:3e:1d:3d:01,nw_src=10.100.5.8,actions=ct(commit,zone=5001),resubmit(,21)"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=41,priority=1001,ct_state=+new+trk,ip,dl_src=fa:16:3e:13:85:be,nw_src=10.100.5.9,actions=ct(commit,zone=5002),resubmit(,21)"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=251,priority=61011,ip,dl_dst=fa:16:3e:1d:3d:01,nw_dst=10.100.5.8,actions=ct(table=252,zone=5001)"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=251,priority=62011,ip,dl_dst=fa:16:3e:13:85:be,nw_dst=10.100.5.9,actions=ct(table=252,zone=5002)"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=252,priority=1001,ct_state=+new+trk,ip,dl_dst=fa:16:3e:1d:3d:01,nw_dst=10.100.5.8,actions=ct(commit,zone=5001),resubmit(,220)"</span></span><br><span class="line">sudo ovs-ofctl  -O OpenFlow13 add-flow test0 <span class="string">"table=252,priority=1001,ct_state=+new+trk,ip,dl_dst=fa:16:3e:13:85:be,nw_dst=10.100.5.9,actions=ct(commit,zone=5002),resubmit(,220)"</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://vcpu.me/dragonflow_muti_external_network/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="vcpu.me">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/h.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="i博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/dragonflow_muti_external_network/" itemprop="url">dragonflow2018多外网转发方案</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-22T18:00:00+08:00">
                2018-04-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dragonflow/" itemprop="url" rel="index">
                    <span itemprop="name">dragonflow</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/dragonflow_muti_external_network/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="dragonflow_muti_external_network/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/dragonflow_muti_external_network/" class="leancloud_visitors" data-flag-title="dragonflow2018多外网转发方案">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>笔者曾经在draonglow开发社区launchpad询问过此问题<br><a href="https://answers.launchpad.net/dragonflow/+question/668047" target="_blank" rel="noopener">https://answers.launchpad.net/dragonflow/+question/668047</a><br>问题描述见我的这篇博文：<br><a href="http://vcpu.me/dnat/">http://vcpu.me/dnat/</a><br>但是没有得到答案，下文为我尝试出来的一个可行方案，与大家共享</p>
<h2 id="dragonflow2018-fip转发基本过程"><a href="#dragonflow2018-fip转发基本过程" class="headerlink" title="dragonflow2018 fip转发基本过程"></a>dragonflow2018 fip转发基本过程</h2><p>dragonflow2018版本distributed dnat（分布式浮动ip）会需要一个放置外网口的ovs桥(后续称呼为br-ex),dragonflow2018的分布式floating ip会将数据包发给该bridge，由该bridge l3 forwarding，将floating ip流量送出外网；在这个过程中外网的网桥需要起到三层网关的作用</p>
<h2 id="多外网fip支持条件"><a href="#多外网fip支持条件" class="headerlink" title="多外网fip支持条件"></a>多外网fip支持条件</h2><p>条件1:支持多外网fip需要申请多个vlan外网</p>
<p>条件2:多个vlan外网需要在br-ex能够三层转发</p>
<p>条件3:br-ex和上联交换机是三层互通</p>
<h3 id="多个vlan外网需要在br-ex能够三层转发"><a href="#多个vlan外网需要在br-ex能够三层转发" class="headerlink" title="多个vlan外网需要在br-ex能够三层转发"></a>多个vlan外网需要在br-ex能够三层转发</h3><p>br-ex想要完成vlan流量的三层转发，需要在br-ex上配置fake bridge (br-ex内部口), 给fake bridge配置上三层地址并加上tag属性；且该fake bridge能够和交换机的网关互通。</p>
<p>vlan fip 外向流量的目的mac需要是相同tag接口的mac; 这样vlan fip外出流量在到达br-ex时候会根据路由找到网关mac地址进行三层转发。</p>
<p>那就意味着n个不同vlan网络需要n个fake bridge口才能进行转发。</p>
<h3 id="br-ex和上联交换机是三层互通"><a href="#br-ex和上联交换机是三层互通" class="headerlink" title="br-ex和上联交换机是三层互通"></a>br-ex和上联交换机是三层互通</h3><p>使用br-ex上对应vlan的fake bridge口能够和交换机互联，fake bridge的网关配置在物理交换机上，和网关互通。</p>
<h1 id="两种方案"><a href="#两种方案" class="headerlink" title="两种方案"></a>两种方案</h1><p>方案1: 互联的地址使用fip网段的地址，fip网关直接落到物理交换机上，在br-ex根据外网vlan号新增两个br-ex三层网关口</p>
<p>eg:</p>
<p>192.168.57.10 属于vlan207 是vlan207 外网fip的网关</p>
<p>192.168.58.10 属于vlan208 是vlan208 外网fip 的网关</p>
<p>vlan 207 外部网络需要在br-ex新增如下配置：</p>
<p>sudo ovs-vsctl add-br vlan207 br-ex 207</p>
<p>sudo ifconfig vlan207 192.168.57.155/24 up</p>
<p>vlan 208 外部网络需要在br-ex新增如下配置：</p>
<p>sudo ovs-vsctl add-br vlan208 br-ex 208</p>
<p>sudo ifconfig vlan208 192.168.58.155/24 up</p>
<p>配置策略路由，不同fip出去的网关不同：</p>
<p>sudo ip rule add from 192.168.57.0/24 table 10</p>
<p>sudo ip route add default via 192.168.57.10 table 10</p>
<p>sudo ip rule add from 192.168.58.0/24 table 11</p>
<p>sudo ip route add default via 192.168.58.10 table 11</p>
<p>！！！如果你不想修改mac地址转发逻辑可以直接将新增的fake bridge mac修改和br-ex默认mac地址一样</p>
<p>sudo ifconfig vlan208 hw ether 08:00:27:12:3f:5b</p>
<p><img src="/myimages/711E78DDE4025198BA5810EE7284568A.png" alt="dd.png"></p>
<p>优点：fip网关直接一步落到物理设备上</p>
<p>缺点：每个计算节点占用了一个外网地址，浪费fip</p>
<p>方案2:使用私有网地址完成fake bridge和物理网络的互联</p>
<p><img src="/myimages/0F5B5A9828A2D3252ACB5C2B2805F657.png" alt="dd.png"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://vcpu.me/dnat/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="vcpu.me">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/h.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="i博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/dnat/" itemprop="url">Using vlan external netowrk fip，dragonflow dirtributed dnat does not work</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-18T12:00:00+08:00">
                2018-04-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dragonflow/" itemprop="url" rel="index">
                    <span itemprop="name">dragonflow</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/dnat/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="dnat/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/dnat/" class="leancloud_visitors" data-flag-title="Using vlan external netowrk fip，dragonflow dirtributed dnat does not work">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>My problem is :<br> Dragonflow distributed dnat can work ok when external network type is vlan ? if ok ,dragonflow distributed dnat support two or more external vlan network ?</p>
<p>Details below:</p>
<h1 id="Using-flat-external-netowork-fip-，-dragonflow-distributed-dnat-work-fine"><a href="#Using-flat-external-netowork-fip-，-dragonflow-distributed-dnat-work-fine" class="headerlink" title="Using flat external netowork fip ， dragonflow distributed dnat work fine"></a>Using flat external netowork fip ， dragonflow distributed dnat work fine</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">+------------------------------------------------------+                   +----------------------------------+</span><br><span class="line">|                                                      |                   |                   MARK: C        |</span><br><span class="line">|                   br-ex                    enp0s3    |XXXXXXXXXXXXXXXXXXX| <span class="number">192.168</span><span class="number">.56</span><span class="number">.10</span>                    |</span><br><span class="line">|                  <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:<span class="number">12</span>:<span class="number">3</span>f:<span class="number">5</span>b                   |                   | external network gateway         |</span><br><span class="line">|                  <span class="number">192.168</span><span class="number">.56</span><span class="number">.155</span>                      |                   |                                  |</span><br><span class="line">+------------------------------------------------------+                   +----------------------------------+</span><br><span class="line">                    |</span><br><span class="line">                    |</span><br><span class="line">                    |</span><br><span class="line">                    |</span><br><span class="line">                    |</span><br><span class="line">                    |</span><br><span class="line">                    |</span><br><span class="line">   +-----------------------------------------------------------+             flows: A -&gt; br-int(dnat) -&gt; br-ex(l3 forward) -&gt; C</span><br><span class="line">   |                                                           |</span><br><span class="line">   |                                                           |</span><br><span class="line">   |                         br-int                            |</span><br><span class="line">   |                                                           |</span><br><span class="line">   |                                                           |</span><br><span class="line">   +-----------------------------------------------------------+</span><br><span class="line">                             |</span><br><span class="line">                             |</span><br><span class="line">                             |        fa:<span class="number">16</span>:<span class="number">3</span>e:d4:<span class="number">60</span>:<span class="number">2</span>d</span><br><span class="line">                             |        flat floating ip <span class="number">192.168</span><span class="number">.56</span><span class="number">.55</span></span><br><span class="line">                             |         dragonflow distribute dnat</span><br><span class="line">                             |</span><br><span class="line">                    +--------------------+</span><br><span class="line">                    |  <span class="number">1.1</span><span class="number">.1</span><span class="number">.6</span>           |</span><br><span class="line">                    |            Mark: A |</span><br><span class="line">                    |                    |</span><br><span class="line">                    |                    |</span><br><span class="line">                    +--------------------+</span><br></pre></td></tr></table></figure>
<p>Instructions：</p>
<p>192.168.56.0/24 is my external flat network subnet. </p>
<p>using dragonflow dnat </p>
<p>A->C icmp flows: A -> br-int(dnat) -> br-ex(l3 forward) -> C</p>
<p>1.1.1.6 with fip ping gateway.( A->C connected). When icmp packet arrived at br-ex , layer3 forwarding is noraml.</p>
<p>Catch packets in br-ex interface.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tcpdump: verbose output suppressed, use -v <span class="keyword">or</span> -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on br-ex, link-type EN10MB (Ethernet), capture size <span class="number">262144</span> bytes</span><br><span class="line"><span class="number">21</span>:<span class="number">40</span>:<span class="number">50.340646</span> fa:<span class="number">16</span>:<span class="number">3</span>e:d4:<span class="number">60</span>:<span class="number">2</span>d &gt; <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:<span class="number">12</span>:<span class="number">3</span>f:<span class="number">5</span>b, ethertype IPv4 (<span class="number">0x0800</span>), length <span class="number">98</span>: <span class="number">192.168</span><span class="number">.56</span><span class="number">.55</span> &gt; <span class="number">114.114</span><span class="number">.114</span><span class="number">.114</span>: ICMP echo request, id <span class="number">22785</span>, seq <span class="number">188</span>, length <span class="number">64</span></span><br><span class="line"><span class="number">21</span>:<span class="number">40</span>:<span class="number">50.340672</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:<span class="number">12</span>:<span class="number">3</span>f:<span class="number">5</span>b &gt; be:e5:f2:da:<span class="number">42</span>:<span class="number">46</span>, ethertype IPv4 (<span class="number">0x0800</span>), length <span class="number">98</span>: <span class="number">192.168</span><span class="number">.56</span><span class="number">.55</span> &gt; <span class="number">114.114</span><span class="number">.114</span><span class="number">.114</span>: ICMP echo request, id <span class="number">22785</span>, seq <span class="number">188</span>, length <span class="number">64</span></span><br><span class="line"><span class="number">21</span>:<span class="number">40</span>:<span class="number">51.341668</span> fa:<span class="number">16</span>:<span class="number">3</span>e:d4:<span class="number">60</span>:<span class="number">2</span>d &gt; <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:<span class="number">12</span>:<span class="number">3</span>f:<span class="number">5</span>b, ethertype IPv4 (<span class="number">0x0800</span>), length <span class="number">98</span>: <span class="number">192.168</span><span class="number">.56</span><span class="number">.55</span> &gt; <span class="number">114.114</span><span class="number">.114</span><span class="number">.114</span>: ICMP echo request, id <span class="number">22785</span>, seq <span class="number">189</span>, length <span class="number">64</span></span><br><span class="line"><span class="number">21</span>:<span class="number">40</span>:<span class="number">51.341696</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:<span class="number">12</span>:<span class="number">3</span>f:<span class="number">5</span>b &gt; be:e5:f2:da:<span class="number">42</span>:<span class="number">46</span>, ethertype IPv4 (<span class="number">0x0800</span>), length <span class="number">98</span>: <span class="number">192.168</span><span class="number">.56</span><span class="number">.55</span> &gt; <span class="number">114.114</span><span class="number">.114</span><span class="number">.114</span>: ICMP echo request, id <span class="number">22785</span>, seq <span class="number">189</span>, length <span class="number">64</span></span><br></pre></td></tr></table></figure>
<p>tcpdump catch packets in enp0s3</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">listening on enp0s3, link-type EN10MB (Ethernet), capture size <span class="number">262144</span> bytes</span><br><span class="line"><span class="number">21</span>:<span class="number">43</span>:<span class="number">01.601739</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:<span class="number">12</span>:<span class="number">3</span>f:<span class="number">5</span>b &gt; be:e5:f2:da:<span class="number">42</span>:<span class="number">46</span>, ethertype IPv4 (<span class="number">0x0800</span>), length <span class="number">98</span>: <span class="number">192.168</span><span class="number">.56</span><span class="number">.55</span> &gt; <span class="number">114.114</span><span class="number">.114</span><span class="number">.114</span>: ICMP echo request, id <span class="number">22785</span>, seq <span class="number">319</span>, length <span class="number">64</span></span><br><span class="line"><span class="number">21</span>:<span class="number">43</span>:<span class="number">01.609858</span> be:e5:f2:da:<span class="number">42</span>:<span class="number">46</span> &gt; fa:<span class="number">16</span>:<span class="number">3</span>e:d4:<span class="number">60</span>:<span class="number">2</span>d, ethertype IPv4 (<span class="number">0x0800</span>), length <span class="number">98</span>: <span class="number">114.114</span><span class="number">.114</span><span class="number">.114</span> &gt; <span class="number">192.168</span><span class="number">.56</span><span class="number">.55</span>: ICMP echo reply, id <span class="number">22785</span>, seq <span class="number">319</span>, length <span class="number">64</span></span><br><span class="line"><span class="number">21</span>:<span class="number">43</span>:<span class="number">02.602343</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:<span class="number">12</span>:<span class="number">3</span>f:<span class="number">5</span>b &gt; be:e5:f2:da:<span class="number">42</span>:<span class="number">46</span>, ethertype IPv4 (<span class="number">0x0800</span>), length <span class="number">98</span>: <span class="number">192.168</span><span class="number">.56</span><span class="number">.55</span> &gt; <span class="number">114.114</span><span class="number">.114</span><span class="number">.114</span>: ICMP echo request, id <span class="number">22785</span>, seq <span class="number">320</span>, length <span class="number">64</span></span><br><span class="line"><span class="number">21</span>:<span class="number">43</span>:<span class="number">02.611243</span> be:e5:f2:da:<span class="number">42</span>:<span class="number">46</span> &gt; fa:<span class="number">16</span>:<span class="number">3</span>e:d4:<span class="number">60</span>:<span class="number">2</span>d, ethertype IPv4 (<span class="number">0x0800</span>), length <span class="number">98</span>: <span class="number">114.114</span><span class="number">.114</span><span class="number">.114</span> &gt; <span class="number">192.168</span><span class="number">.56</span><span class="number">.55</span>: ICMP echo reply, id <span class="number">22785</span>, seq <span class="number">320</span>, length <span class="number">64</span></span><br></pre></td></tr></table></figure>
<h1 id="Using-vlan-external-netowrk-fip，dragonflow-dirtributed-dnat-does-not-work"><a href="#Using-vlan-external-netowrk-fip，dragonflow-dirtributed-dnat-does-not-work" class="headerlink" title="Using vlan external netowrk fip，dragonflow dirtributed dnat does not work"></a>Using vlan external netowrk fip，dragonflow dirtributed dnat does not work</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">+------------------------------------------------------+                   +----------------------------------+</span><br><span class="line">|                                                      |                   |                   MARK: C        |</span><br><span class="line">|                   br-ex                    enp0s3    |XXXXXXXXXXXXXXXXXXX| <span class="number">192.168</span><span class="number">.57</span><span class="number">.10</span>                    |</span><br><span class="line">|                  <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:<span class="number">12</span>:<span class="number">3</span>f:<span class="number">5</span>b                   |                   | external vlan network gateway    |</span><br><span class="line">|                  <span class="number">192.168</span><span class="number">.56</span><span class="number">.155</span>                      |                   |                                  |</span><br><span class="line">+------------------------------------------------------+                   +----------------------------------+</span><br><span class="line">                    |</span><br><span class="line">                    |                                                                                                 +</span><br><span class="line">                    |                                                                                                 |</span><br><span class="line">                    |                                                                                                 |</span><br><span class="line">                    |                                                                                                 |</span><br><span class="line">                    |                                                                                                 |</span><br><span class="line">                    |                                                                                                 v</span><br><span class="line">   +-----------------------------------------------------------+             flows: A -&gt; br-int(dnat) -&gt; br-ex(l3 forward) -&gt; C</span><br><span class="line">   |                                                           |</span><br><span class="line">   |                                                           |</span><br><span class="line">   |                         br-int                            |                                          work err here</span><br><span class="line">   |                                                           |</span><br><span class="line">   |                                                           |</span><br><span class="line">   +-----------------------------------------------------------+</span><br><span class="line">                             |</span><br><span class="line">                             |</span><br><span class="line">                             |      fa:<span class="number">16</span>:<span class="number">3</span>e:<span class="number">39</span>:<span class="number">63</span>:c2</span><br><span class="line">                             |       vlan external network fip : <span class="number">192.168</span><span class="number">.57</span><span class="number">.159</span></span><br><span class="line">                             |</span><br><span class="line">                             |</span><br><span class="line">                    +--------------------+</span><br><span class="line">                    |  <span class="number">1.1</span><span class="number">.1</span><span class="number">.6</span>           |</span><br><span class="line">                    |            Mark: A |</span><br><span class="line">                    |                    |</span><br><span class="line">                    |                    |</span><br><span class="line">                    +--------------------+</span><br></pre></td></tr></table></figure>
<p>Catch packets in br-ex interface. and I find that icmp packet can not be l3 forwarded in br-ex . A -> c disconnect.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">stack@p-controller:~/devstack$ sudo tcpdump -i br-ex -ne</span><br><span class="line">tcpdump: verbose output suppressed, use -v <span class="keyword">or</span> -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on br-ex, link-type EN10MB (Ethernet), capture size <span class="number">262144</span> bytes</span><br><span class="line"><span class="number">21</span>:<span class="number">58</span>:<span class="number">36.278770</span> fa:<span class="number">16</span>:<span class="number">3</span>e:<span class="number">39</span>:<span class="number">63</span>:c2 &gt; <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:<span class="number">12</span>:<span class="number">3</span>f:<span class="number">5</span>b, ethertype <span class="number">802.1</span>Q (<span class="number">0x8100</span>), length <span class="number">102</span>: vlan <span class="number">207</span>, p <span class="number">0</span>, ethertype IPv4, <span class="number">192.168</span><span class="number">.57</span><span class="number">.159</span> &gt; <span class="number">114.114</span><span class="number">.114</span><span class="number">.114</span>: ICMP echo request, id <span class="number">23041</span>, seq <span class="number">15</span>, length <span class="number">64</span></span><br><span class="line"><span class="number">21</span>:<span class="number">58</span>:<span class="number">37.279352</span> fa:<span class="number">16</span>:<span class="number">3</span>e:<span class="number">39</span>:<span class="number">63</span>:c2 &gt; <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:<span class="number">12</span>:<span class="number">3</span>f:<span class="number">5</span>b, ethertype <span class="number">802.1</span>Q (<span class="number">0x8100</span>), length <span class="number">102</span>: vlan <span class="number">207</span>, p <span class="number">0</span>, ethertype IPv4, <span class="number">192.168</span><span class="number">.57</span><span class="number">.159</span> &gt; <span class="number">114.114</span><span class="number">.114</span><span class="number">.114</span>: ICMP echo request, id <span class="number">23041</span>, seq <span class="number">16</span>, length <span class="number">64</span></span><br><span class="line"><span class="number">21</span>:<span class="number">58</span>:<span class="number">38.279781</span> fa:<span class="number">16</span>:<span class="number">3</span>e:<span class="number">39</span>:<span class="number">63</span>:c2 &gt; <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:<span class="number">12</span>:<span class="number">3</span>f:<span class="number">5</span>b, ethertype <span class="number">802.1</span>Q (<span class="number">0x8100</span>), length <span class="number">102</span>: vlan <span class="number">207</span>, p <span class="number">0</span>, ethertype IPv4, <span class="number">192.168</span><span class="number">.57</span><span class="number">.159</span> &gt; <span class="number">114.114</span><span class="number">.114</span><span class="number">.114</span>: ICMP echo request, id <span class="number">23041</span>, seq <span class="number">17</span>, length <span class="number">64</span></span><br></pre></td></tr></table></figure>
<p>My problem is :</p>
<p> Dragonflow distributed dnat can work ok when external network type is vlan ? if ok ,dragonflow distributed dnat support two or more external vlan network ?</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://vcpu.me/dragonflow_flows/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="vcpu.me">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/h.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="i博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/dragonflow_flows/" itemprop="url">Dragonflow openvswitch流表实现原理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-17T18:00:00+08:00">
                2018-04-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dragonflow/" itemprop="url" rel="index">
                    <span itemprop="name">dragonflow</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/dragonflow_flows/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="dragonflow_flows/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/dragonflow_flows/" class="leancloud_visitors" data-flag-title="Dragonflow openvswitch流表实现原理">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="独立唯一的标记"><a href="#独立唯一的标记" class="headerlink" title="独立唯一的标记"></a>独立唯一的标记</h1><p>dragonflow 2018 所有的云主机接口会被分配到一个全局独立唯一的id；这个标记可以理解成云主机网络路径的一种抽象，每个云主机的网络路径不同的，二三层通信过程实际是在选择对应通信目标的网络路径，然后进行数据包转发，所以这些id在云主之间通信起到至关重要的作用。</p>
<h1 id="云主机之间的通信"><a href="#云主机之间的通信" class="headerlink" title="云主机之间的通信"></a>云主机之间的通信</h1><p>云主机A和云主机B，位于同一个subnet；它们的通信过程是：云主机A发出的数据包会跑到table55，根据目的mac选择网络路径（id设置到reg7）;</p>
<p>本机table115会根据选择的网络路径将数据包转发，其它节点，会根据网络路径将数据包发给vxlan隧道</p>
<p>同一个路由，跨子网情况下，table55会根据目的网关的mac匹配，因为是发给网关流量设置reg5=1，交给table60匹配目的ip网段，确定子网信息（设置metadata标识），最后根据目的ip和子网信息，匹配table65找寻最后的网络路径。</p>
<h1 id="网络节点qr和云主机通信"><a href="#网络节点qr和云主机通信" class="headerlink" title="网络节点qr和云主机通信"></a>网络节点qr和云主机通信</h1><p>l2 table根据网关mac判断，设置reg5=1 代表三层流量，l3 table根据mac（也有根据网关的ip） 选择网络路径</p>
<h1 id="DNAT"><a href="#DNAT" class="headerlink" title="DNAT"></a>DNAT</h1><p>dnat属于三层流量，会经过table55 设置reg5=1交给三层table60处理；table60根据源地址发现该流量需要dnat，交给table77；最新的方案中的目的mac是最后决定的，所以需要将流量</p>
<p>从定向到table55，table55会帮助引导，重新最后设置mac地址后发出的。</p>
<p>回来的流量直接到table55，根据目的 mac判断是fip流量后，外网fip流量交给table75分流后交给table75 nat还原；还原后从新到table55 重新寻找具体网络路径。</p>
<h1 id="SNAT"><a href="#SNAT" class="headerlink" title="SNAT"></a>SNAT</h1><p>访问外网地址114.114.114.114，云主机发出的流量经过table55，因为目的mac是子网网关mac，所以标记三层流量交给table60，交给table70区做snat，最后交给table71将流量发出</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://vcpu.me/self-service_and_provider_flows/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="vcpu.me">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/h.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="i博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/self-service_and_provider_flows/" itemprop="url">dragonflow self-service 和 provider通信流量走向图示</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-11T18:00:00+08:00">
                2018-04-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dragonflow/" itemprop="url" rel="index">
                    <span itemprop="name">dragonflow</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/self-service_and_provider_flows/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="self-service_and_provider_flows/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/self-service_and_provider_flows/" class="leancloud_visitors" data-flag-title="dragonflow self-service 和 provider通信流量走向图示">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="vm1-ping-the-same-compute-provider-vm-qg-in-br-ex"><a href="#vm1-ping-the-same-compute-provider-vm-qg-in-br-ex" class="headerlink" title="vm1 ping the same compute provider vm (qg in br-ex)"></a>vm1 ping the same compute provider vm (qg in br-ex)</h1><p><img src="/myimages/09AA6755522B94AFD3CDDE7BD897A6F7.png" alt="dd.png"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[&apos;1.1.1.12&apos;] [&apos;fa:16:3e:9a:cd:f1&apos;] 0x82</span><br><span class="line">[&apos;1.1.1.2&apos;] [&apos;fa:16:3e:21:35:2a&apos;] 0x1e</span><br><span class="line">[&apos;192.168.56.58&apos;] [&apos;fa:16:3e:8d:ce:3d&apos;] 0x23</span><br><span class="line">[&apos;192.168.56.59&apos;] [&apos;fa:16:3e:11:d7:3e&apos;] 0x7c</span><br><span class="line">[&apos;192.168.56.67&apos;] [&apos;fa:16:3e:9f:0b:ef&apos;] 0x85</span><br><span class="line">[&apos;192.168.56.53&apos;] [&apos;fa:16:3e:21:be:e8&apos;] 0x7d</span><br><span class="line">[&apos;192.168.56.62&apos;] [&apos;fa:16:3e:26:36:07&apos;] 0x7f</span><br><span class="line">[&apos;1.1.1.8&apos;] [&apos;fa:16:3e:83:38:2c&apos;] 0x83</span><br><span class="line">[&apos;192.168.56.50&apos;] [&apos;fa:16:3e:a4:37:0b&apos;] 0x1b</span><br><span class="line">[&apos;1.1.1.5&apos;] [&apos;fa:16:3e:6c:c0:49&apos;] 0x81</span><br><span class="line">[&apos;1.1.1.4&apos;] [&apos;fa:16:3e:18:7c:d6&apos;] 0x80</span><br><span class="line">[&apos;192.168.56.60&apos;] [&apos;fa:16:3e:41:ef:d4&apos;] 0x25</span><br><span class="line">[&apos;192.168.56.52&apos;] [&apos;fa:16:3e:c6:23:7e&apos;] 0x7e</span><br><span class="line">[&apos;192.168.56.55&apos;] [&apos;fa:16:3e:d4:60:2d&apos;] 0x84</span><br><span class="line">[&apos;1.1.1.1&apos;] [&apos;fa:16:3e:07:f8:41&apos;] 0x20</span><br></pre></td></tr></table></figure></p>
<p>vm1 -&gt; qr<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> cookie=0x0, duration=460.782s, table=0, n_packets=308, n_bytes=29680, idle_age=0, priority=100,in_port=25 actions=load:0x83-&gt;NXM_NX_REG6[],load:0x8-&gt;OXM_OF_METADATA[],load:0-&gt;OXM_OF_IN_PORT[],resubmit(,)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=545.398s, table=0, n_packets=1195, n_bytes=114344, idle_age=0, priority=1 actions=resubmit(,5)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=588.146s, table=5, n_packets=426, n_bytes=41748, idle_age=0, priority=200,ip,reg6=0x83,dl_src=fa:16:3e:83:38:2c,nw_src=1.1.1.8 actions=resubmit(,10)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=610.596s, table=10, n_packets=448, n_bytes=43904, idle_age=0, priority=100,ip,reg6=0x83 actions=ct(table=15,zone=OXM_OF_METADATA[0..15])</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=632.912s, table=15, n_packets=933, n_bytes=91434, idle_age=1, priority=65534,ct_state=-new+est-rel-inv+trk actions=resubmit(,20)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=640.105s, table=20, n_packets=1422, n_bytes=139356, idle_age=1, priority=1 actions=resubmit(,55)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=667.682s, table=55, n_packets=505, n_bytes=49490, idle_age=0, priority=200,metadata=0x8,dl_dst=fa:16:3e:07:f8:41 actions=load:0x2-&gt;NXM_NX_REG5[],resubmit(,60)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=681.907s, table=60, n_packets=519, n_bytes=50862, idle_age=0, priority=20,metadata=0x8,dl_dst=fa:16:3e:07:f8:41 actions=load:0x20-&gt;NXM_NX_REG7[],resubmit(,75)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=702.994s, table=75, n_packets=540, n_bytes=52920, idle_age=1, priority=100,reg7=0x20 actions=resubmit(,105)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=755.881s, table=105, n_packets=751, n_bytes=67174, idle_age=0, priority=1 actions=resubmit(,115)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=761.733s, table=115, n_packets=616, n_bytes=59416, idle_age=1, priority=100,reg7=0x20 actions=output:4</span><br></pre></td></tr></table></figure></p>
<p>qg -&gt; provider vm2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cookie=0x0, duration=779.369s, table=0, n_packets=900, n_bytes=78729, idle_age=0, priority=50,in_port=1,vlan_tci=0x0000/0x1fff actions=load:0-&gt;OXM_OF_IN_PORT[],load:0x7-&gt;OXM_OF_METADATA[],load:0x64-&gt;NXM_NX_REG8[],resubmit(,2)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=787.445s, table=2, n_packets=908, n_bytes=79399, idle_age=0, priority=1 actions=resubmit(,55)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=815.975s, table=55, n_packets=671, n_bytes=64750, idle_age=0, priority=100,metadata=0x7,dl_dst=fa:16:3e:26:36:07 actions=load:0x7f-&gt;NXM_NX_REG7[],resubmit(,75)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=834.281s, table=75, n_packets=783, n_bytes=73781, idle_age=0, priority=100,reg7=0x7f actions=resubmit(,105)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=864.773s, table=105, n_packets=706, n_bytes=70633, idle_age=0, priority=100,ip,reg7=0x7f actions=ct(table=110,zone=OXM_OF_METADATA[0..15])</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=894.181s, table=110, n_packets=1455, n_bytes=142590, idle_age=0, priority=65534,ct_state=-new+est-rel-inv+trk actions=resubmit(,115)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=897.977s, table=115, n_packets=877, n_bytes=79776, idle_age=1, priority=100,reg7=0x7f actions=output:22</span><br></pre></td></tr></table></figure></p>
<hr>
<p>provider vm2 -&gt; qg<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cookie=0x0, duration=906.113s, table=0, n_packets=788, n_bytes=74760, idle_age=0, priority=100,in_port=22 actions=load:0x7f-&gt;NXM_NX_REG6[],load:0x7-&gt;OXM_OF_METADATA[],load:0-&gt;OXM_OF_IN_PORT[],resubmit(,)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=915.570s, table=0, n_packets=2345, n_bytes=224804, idle_age=0, priority=1 actions=resubmit(,5)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=938.984s, table=5, n_packets=776, n_bytes=76048, idle_age=0, priority=200,ip,reg6=0x7f,dl_src=fa:16:3e:26:36:07,nw_src=192.168.56.62 actions=resubmit(,10)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=951.183s, table=10, n_packets=788, n_bytes=77224, idle_age=0, priority=100,ip,reg6=0x7f actions=ct(table=15,zone=OXM_OF_METADATA[0..15])</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=972.483s, table=15, n_packets=1611, n_bytes=157878, idle_age=1, priority=65534,ct_state=-new+est-rel-inv+trk actions=resubmit(,20)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=984.694s, table=20, n_packets=2454, n_bytes=240492, idle_age=1, priority=1 actions=resubmit(,55)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=1028.389s, table=55, n_packets=889, n_bytes=85778, idle_age=0, priority=100,metadata=0x7,dl_dst=fa:16:3e:41:ef:d4 actions=load:0x25-&gt;NXM_NX_REG7[],resubmit(,75)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=1041.584s, table=75, n_packets=904, n_bytes=87192, idle_age=0, priority=100,reg7=0x25 actions=resubmit(,80)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=1071.120s, table=80, n_packets=934, n_bytes=90076, idle_age=0, priority=100,metadata=0x7 actions=output:1</span><br></pre></td></tr></table></figure></p>
<p>qr -&gt; vm1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> cookie=0x0, duration=1098.192s, table=0, n_packets=963, n_bytes=92806, idle_age=0, priority=100,in_port=4 actions=load:0x20-&gt;NXM_NX_REG6[],load:0x8-&gt;OXM_OF_METADATA[],load:0-&gt;OXM_OF_IN_PORT[],resubmit(,)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=1124.903s, table=0, n_packets=2996, n_bytes=287090, idle_age=1, priority=1 actions=resubmit(,5)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=1180.867s, table=5, n_packets=1048, n_bytes=100968, idle_age=1, priority=200,reg6=0x20 actions=resubmit(,10)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=1207.420s, table=10, n_packets=1073, n_bytes=103362, idle_age=0, priority=1 actions=resubmit(,20)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=1220.656s, table=20, n_packets=3162, n_bytes=309876, idle_age=0, priority=1 actions=resubmit(,55)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=1247.127s, table=55, n_packets=1083, n_bytes=106134, idle_age=1, priority=100,metadata=0x8,dl_dst=fa:16:3e:83:38:2c actions=load:0x83-&gt;NXM_NX_REG7[],resubmit(,75)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=1277.609s, table=75, n_packets=1113, n_bytes=109074, idle_age=1, priority=100,reg7=0x83 actions=resubmit(,105)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=1316.182s, table=105, n_packets=1152, n_bytes=112896, idle_age=0, priority=100,ip,reg7=0x83 actions=ct(table=110,zone=OXM_OF_METADATA[0..15])</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=1331.477s, table=110, n_packets=2329, n_bytes=228242, idle_age=0, priority=65534,ct_state=-new+est-rel-inv+trk actions=resubmit(,115)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=1347.498s, table=115, n_packets=1216, n_bytes=117376, idle_age=0, priority=100,reg7=0x83 actions=output:25</span><br></pre></td></tr></table></figure></p>
<h1 id="vm1-ping-qg-qg-in-br-int"><a href="#vm1-ping-qg-qg-in-br-int" class="headerlink" title="vm1 ping qg (qg in br-int)"></a>vm1 ping qg (qg in br-int)</h1><p>[‘1.1.1.2’] [‘fa:16:3e:21:35:2a’] 0x1e</p>
<p>[‘192.168.56.58’] [‘fa:16:3e:8d:ce:3d’] 0x23</p>
<p>[‘1.1.1.4’] [‘fa:16:3e:b2:81:08’] 0x8a</p>
<p>[‘192.168.56.67’] [‘fa:16:3e:9f:0b:ef’] 0x85</p>
<p>[‘192.168.56.52’] [‘fa:16:3e:69:94:3e’] 0x87</p>
<p>[‘192.168.56.50’] [‘fa:16:3e:a4:37:0b’] 0x1b</p>
<p>[‘192.168.56.61’] [‘fa:16:3e:9b:c9:e2’] 0x86</p>
<p>[‘192.168.56.51’] [‘fa:16:3e:e3:27:bd’] 0x88</p>
<p>[‘1.1.1.7’] [‘fa:16:3e:ad:73:37’] 0x89</p>
<p>[‘192.168.56.55’] [‘fa:16:3e:d4:60:2d’] 0x84</p>
<p>[‘1.1.1.1’] [‘fa:16:3e:07:f8:41’] 0x20</p>
<p><img src="/myimages/7FFABAB0331411C0BC0565E30410BE00.png" alt="dd.png"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> cookie=0x0, duration=241.057s, table=0, n_packets=247, n_bytes=23870, idle_age=0, priority=100,in_port=28 actions=load:0x8a-&gt;NXM_NX_REG6[],load:0x8-&gt;OXM_OF_METADATA[],load:0-&gt;OXM_OF_IN_PORT[],resubmit(,)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=264.039s, table=0, n_packets=546, n_bytes=52200, idle_age=0, priority=1 actions=resubmit(,5)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=270.916s, table=5, n_packets=270, n_bytes=26460, idle_age=0, priority=200,ip,reg6=0x8a,dl_src=fa:16:3e:b2:81:08,nw_src=1.1.1.4 actions=resubmit(,10)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=312.605s, table=10, n_packets=312, n_bytes=30576, idle_age=0, priority=100,ip,reg6=0x8a actions=ct(table=15,zone=OXM_OF_METADATA[0..15])</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=332.121s, table=15, n_packets=329, n_bytes=32242, idle_age=0, priority=65534,ct_state=-new+est-rel-inv+trk actions=resubmit(,20)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=346.371s, table=20, n_packets=686, n_bytes=67228, idle_age=0, priority=1 actions=resubmit(,55)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=368.640s, table=55, n_packets=367, n_bytes=35966, idle_age=0, priority=200,metadata=0x8,dl_dst=fa:16:3e:07:f8:41 actions=load:0x2-&gt;NXM_NX_REG5[],resubmit(,60)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=377.877s, table=60, n_packets=167, n_bytes=16366, idle_age=0, priority=20,metadata=0x8,dl_dst=fa:16:3e:07:f8:41 actions=load:0x20-&gt;NXM_NX_REG7[],resubmit(,75)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=393.758s, table=75, n_packets=183, n_bytes=17934, idle_age=0, priority=100,reg7=0x20 actions=resubmit(,105)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=417.581s, table=105, n_packets=607, n_bytes=52082, idle_age=0, priority=1 actions=resubmit(,115)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=429.101s, table=115, n_packets=229, n_bytes=21826, idle_age=0, priority=100,reg7=0x20 actions=output:4</span><br></pre></td></tr></table></figure></p>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> cookie=0x0, duration=528.682s, table=0, n_packets=331, n_bytes=31598, idle_age=1, priority=100,in_port=4 actions=load:0x20-&gt;NXM_NX_REG6[],load:0x8-&gt;OXM_OF_METADATA[],load:0-&gt;OXM_OF_IN_PORT[],resubmit(,)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=546.593s, table=0, n_packets=1128, n_bytes=108228, idle_age=0, priority=1 actions=resubmit(,5)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=761.598s, table=5, n_packets=568, n_bytes=54600, idle_age=0, priority=200,reg6=0x20 actions=resubmit(,10)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=772.279s, table=10, n_packets=799, n_bytes=76566, idle_age=0, priority=1 actions=resubmit(,20)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=782.474s, table=20, n_packets=1556, n_bytes=152488, idle_age=0, priority=1 actions=resubmit(,55)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=801.558s, table=55, n_packets=807, n_bytes=79338, idle_age=0, priority=100,metadata=0x8,dl_dst=fa:16:3e:b2:81:08 actions=load:0x8a-&gt;NXM_NX_REG7[],resubmit(,75)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=823.892s, table=75, n_packets=830, n_bytes=81592, idle_age=0, priority=100,reg7=0x8a actions=resubmit(,105)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=836.139s, table=105, n_packets=842, n_bytes=82768, idle_age=0, priority=100,ip,reg7=0x8a actions=ct(table=110,zone=OXM_OF_METADATA[0..15])</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=846.463s, table=110, n_packets=842, n_bytes=82516, idle_age=0, priority=65534,ct_state=-new+est-rel-inv+trk actions=resubmit(,115)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=854.035s, table=115, n_packets=871, n_bytes=84294, idle_age=0, priority=100,reg7=0x8a actions=output:28</span><br></pre></td></tr></table></figure>
<h1 id="vm1-ping-provider-vm2-qg-in-br-int"><a href="#vm1-ping-provider-vm2-qg-in-br-int" class="headerlink" title="vm1 ping provider vm2 (qg in br-int)"></a>vm1 ping provider vm2 (qg in br-int)</h1><p><img src="/myimages/349CD6577C031F82FF9284E9FBEA378C.png" alt="dd.png"></p>
<p>vm1 -&gt; qr<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cookie=0x0, duration=241.057s, table=0, n_packets=247, n_bytes=23870, idle_age=0, priority=100,in_port=28 actions=load:0x8a-&gt;NXM_NX_REG6[],load:0x8-&gt;OXM_OF_METADATA[],load:0-&gt;OXM_OF_IN_PORT[],resubmit(,)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=264.039s, table=0, n_packets=546, n_bytes=52200, idle_age=0, priority=1 actions=resubmit(,5)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=270.916s, table=5, n_packets=270, n_bytes=26460, idle_age=0, priority=200,ip,reg6=0x8a,dl_src=fa:16:3e:b2:81:08,nw_src=1.1.1.4 actions=resubmit(,10)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=312.605s, table=10, n_packets=312, n_bytes=30576, idle_age=0, priority=100,ip,reg6=0x8a actions=ct(table=15,zone=OXM_OF_METADATA[0..15])</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=332.121s, table=15, n_packets=329, n_bytes=32242, idle_age=0, priority=65534,ct_state=-new+est-rel-inv+trk actions=resubmit(,20)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=346.371s, table=20, n_packets=686, n_bytes=67228, idle_age=0, priority=1 actions=resubmit(,55)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=368.640s, table=55, n_packets=367, n_bytes=35966, idle_age=0, priority=200,metadata=0x8,dl_dst=fa:16:3e:07:f8:41 actions=load:0x2-&gt;NXM_NX_REG5[],resubmit(,60)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=377.877s, table=60, n_packets=167, n_bytes=16366, idle_age=0, priority=20,metadata=0x8,dl_dst=fa:16:3e:07:f8:41 actions=load:0x20-&gt;NXM_NX_REG7[],resubmit(,75)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=393.758s, table=75, n_packets=183, n_bytes=17934, idle_age=0, priority=100,reg7=0x20 actions=resubmit(,105)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=417.581s, table=105, n_packets=607, n_bytes=52082, idle_age=0, priority=1 actions=resubmit(,115)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=429.101s, table=115, n_packets=229, n_bytes=21826, idle_age=0, priority=100,reg7=0x20 actions=output:4</span><br></pre></td></tr></table></figure></p>
<p>qg -&gt; vm2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> cookie=0x0, duration=2374.818s, table=0, n_packets=425, n_bytes=40754, idle_age=0, priority=100,in_port=26 actions=load:0x86-&gt;NXM_NX_REG6[],load:0x7-&gt;OXM_OF_METADATA[],load:0-&gt;OXM_OF_IN_PORT[],resubmit(,)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2424.908s, table=5, n_packets=476, n_bytes=45696, idle_age=0, priority=200,reg6=0x86 actions=resubmit(,10)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2456.728s, table=10, n_packets=2806, n_bytes=270228, idle_age=0, priority=1 actions=resubmit(,20)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2463.825s, table=20, n_packets=5470, n_bytes=536060, idle_age=0, priority=1 actions=resubmit(,55)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=2485.994s, table=55, n_packets=309, n_bytes=30282, idle_age=0, priority=100,metadata=0x7,dl_dst=fa:16:3e:69:94:3e actions=load:0x87-&gt;NXM_NX_REG7[],resubmit(,75)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2509.368s, table=75, n_packets=679, n_bytes=57177, idle_age=0, priority=100,reg7=0x87 actions=resubmit(,105)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2520.571s, table=105, n_packets=364, n_bytes=38581, idle_age=0, priority=100,ip,reg7=0x87 actions=ct(table=110,zone=OXM_OF_METADATA[0..15])</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2529.962s, table=110, n_packets=2866, n_bytes=280868, idle_age=0, priority=65534,ct_state=-new+est-rel-inv+trk actions=resubmit(,115)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2564.873s, table=115, n_packets=735, n_bytes=58610, idle_age=0, priority=100,reg7=0x87 actions=output:27</span><br></pre></td></tr></table></figure></p>
<hr>
<p>vm2 -&gt;qg<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> cookie=0x0, duration=2602.476s, table=0, n_packets=439, n_bytes=42238, idle_age=0, priority=100,in_port=27 actions=load:0x87-&gt;NXM_NX_REG6[],load:0x7-&gt;OXM_OF_METADATA[],load:0-&gt;OXM_OF_IN_PORT[],resubmit(,)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2625.452s, table=0, n_packets=6302, n_bytes=607104, idle_age=0, priority=1 actions=resubmit(,5)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=2635.327s, table=5, n_packets=458, n_bytes=44884, idle_age=0, priority=200,ip,reg6=0x87,dl_src=fa:16:3e:69:94:3e,nw_src=192.168.56.52 actions=resubmit(,10)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2646.544s, table=10, n_packets=469, n_bytes=45962, idle_age=0, priority=100,ip,reg6=0x87 actions=ct(table=15,zone=OXM_OF_METADATA[0..15])</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2662.014s, table=15, n_packets=3130, n_bytes=306740, idle_age=0, priority=65534,ct_state=-new+est-rel-inv+trk actions=resubmit(,20)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2670.162s, table=20, n_packets=6294, n_bytes=616812, idle_age=0, priority=1 actions=resubmit(,55)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2695.409s, table=55, n_packets=735, n_bytes=71694, idle_age=0, priority=100,metadata=0x7,dl_dst=fa:16:3e:9b:c9:e2 actions=load:0x86-&gt;NXM_NX_REG7[],resubmit(,75</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2712.679s, table=75, n_packets=1134, n_bytes=100913, idle_age=0, priority=100,reg7=0x86 actions=resubmit(,105)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2732.390s, table=105, n_packets=4017, n_bytes=369881, idle_age=0, priority=1 actions=resubmit(,115)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2738.911s, table=115, n_packets=1181, n_bytes=104361, idle_age=0, priority=100,reg7=0x86 actions=output:26</span><br></pre></td></tr></table></figure></p>
<p>qr-&gt;vm1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> cookie=0x0, duration=2756.115s, table=0, n_packets=2613, n_bytes=251650, idle_age=1, priority=100,in_port=4 actions=load:0x20-&gt;NXM_NX_REG6[],load:0x8-&gt;OXM_OF_METADATA[],load:0-&gt;OXM_OF_IN_PORT[],resubmit(,)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2779.140s, table=0, n_packets=6936, n_bytes=668228, idle_age=0, priority=1 actions=resubmit(,5)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2831.453s, table=5, n_packets=2690, n_bytes=259084, idle_age=1, priority=200,reg6=0x20 actions=resubmit(,10)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2855.438s, table=10, n_packets=3628, n_bytes=349328, idle_age=0, priority=1 actions=resubmit(,20)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2866.720s, table=20, n_packets=7078, n_bytes=693644, idle_age=0, priority=1 actions=resubmit(,55)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2892.956s, table=55, n_packets=2889, n_bytes=283374, idle_age=1, priority=100,metadata=0x8,dl_dst=fa:16:3e:b2:81:08 actions=load:0x8a-&gt;NXM_NX_REG7[],resubmit(,75)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2907.217s, table=75, n_packets=2904, n_bytes=284844, idle_age=0, priority=100,reg7=0x8a actions=resubmit(,105)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2915.352s, table=105, n_packets=2912, n_bytes=285628, idle_age=0, priority=100,ip,reg7=0x8a actions=ct(table=110,zone=OXM_OF_METADATA[0..15])</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2924.665s, table=110, n_packets=3654, n_bytes=358092, idle_age=0, priority=65534,ct_state=-new+est-rel-inv+trk actions=resubmit(,115)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=2933.173s, table=115, n_packets=3002, n_bytes=289716, idle_age=0, priority=100,reg7=0x8a actions=output:28</span><br></pre></td></tr></table></figure></p>
<h1 id="vm1-ping-fip-qg-in-br-int"><a href="#vm1-ping-fip-qg-in-br-int" class="headerlink" title="vm1 ping fip (qg in br-int)"></a>vm1 ping fip (qg in br-int)</h1><p><img src="/myimages/016DC87B6873864EB633EB5735465F8D.png" alt="dd.png"></p>
<p>vm1 -&gt; qr<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cookie=0x0, duration=241.057s, table=0, n_packets=247, n_bytes=23870, idle_age=0, priority=100,in_port=28 actions=load:0x8a-&gt;NXM_NX_REG6[],load:0x8-&gt;OXM_OF_METADATA[],load:0-&gt;OXM_OF_IN_PORT[],resubmit(,)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=264.039s, table=0, n_packets=546, n_bytes=52200, idle_age=0, priority=1 actions=resubmit(,5)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=270.916s, table=5, n_packets=270, n_bytes=26460, idle_age=0, priority=200,ip,reg6=0x8a,dl_src=fa:16:3e:b2:81:08,nw_src=1.1.1.4 actions=resubmit(,10)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=312.605s, table=10, n_packets=312, n_bytes=30576, idle_age=0, priority=100,ip,reg6=0x8a actions=ct(table=15,zone=OXM_OF_METADATA[0..15])</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=332.121s, table=15, n_packets=329, n_bytes=32242, idle_age=0, priority=65534,ct_state=-new+est-rel-inv+trk actions=resubmit(,20)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=346.371s, table=20, n_packets=686, n_bytes=67228, idle_age=0, priority=1 actions=resubmit(,55)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=368.640s, table=55, n_packets=367, n_bytes=35966, idle_age=0, priority=200,metadata=0x8,dl_dst=fa:16:3e:07:f8:41 actions=load:0x2-&gt;NXM_NX_REG5[],resubmit(,60)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=377.877s, table=60, n_packets=167, n_bytes=16366, idle_age=0, priority=20,metadata=0x8,dl_dst=fa:16:3e:07:f8:41 actions=load:0x20-&gt;NXM_NX_REG7[],resubmit(,75)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=393.758s, table=75, n_packets=183, n_bytes=17934, idle_age=0, priority=100,reg7=0x20 actions=resubmit(,105)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=417.581s, table=105, n_packets=607, n_bytes=52082, idle_age=0, priority=1 actions=resubmit(,115)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=429.101s, table=115, n_packets=229, n_bytes=21826, idle_age=0, priority=100,reg7=0x20 actions=output:4</span><br></pre></td></tr></table></figure></p>
<p>qg -&gt; vm2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"> cookie=0x0, duration=2374.818s, table=0, n_packets=425, n_bytes=40754, idle_age=0, priority=100,in_port=26 actions=load:0x86-&gt;NXM_NX_REG6[],load:0x7-&gt;OXM_OF_METADATA[],load:0-&gt;OXM_OF_IN_PORT[],resubmit(,)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2424.908s, table=5, n_packets=476, n_bytes=45696, idle_age=0, priority=200,reg6=0x86 actions=resubmit(,10)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2456.728s, table=10, n_packets=2806, n_bytes=270228, idle_age=0, priority=1 actions=resubmit(,20)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2463.825s, table=20, n_packets=5470, n_bytes=536060, idle_age=0, priority=1 actions=resubmit(,55)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=366.590s, table=55, n_packets=366, n_bytes=35868, idle_age=0, priority=100,metadata=0x7,dl_dst=fa:16:3e:8d:ce:3d actions=load:0x23-&gt;NXM_NX_REG7[],resubmit(,75)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=390.011s, table=75, n_packets=393, n_bytes=39384, idle_age=0, priority=200,reg7=0x23 actions=resubmit(,76)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=411.413s, table=76, n_packets=413, n_bytes=41400, idle_age=1, priority=100,ip,reg7=0x23 actions=dec_ttl,mod_dl_src:fa:16:3e:07:f8:41,mod_dl_dst:fa:16:3e:39:1d:38,mod_nw_dst:1.1.1.13,load:0x8b-&gt;NXM_NX_REG7[],load:0x8-&gt;OXM_OF_METADATA[],resubmit(,55)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=432.829s, table=55, n_packets=435, n_bytes=43556, idle_age=0, priority=100,metadata=0x8,dl_dst=fa:16:3e:39:1d:38 actions=load:0x8b-&gt;NXM_NX_REG7[],resubmit(,75)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=442.983s, table=75, n_packets=445, n_bytes=44536, idle_age=0, priority=100,reg7=0x8b actions=resubmit(,105)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=517.155s, table=105, n_packets=519, n_bytes=51788, idle_age=0, priority=100,ip,reg7=0x8b actions=ct(table=110,zone=OXM_OF_METADATA[0..15])</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=551.607s, table=110, n_packets=1094, n_bytes=107212, idle_age=1, priority=65534,ct_state=-new+est-rel-inv+trk actions=resubmit(,115)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=536.182s, table=115, n_packets=549, n_bytes=53018, idle_age=0, priority=100,reg7=0x8b actions=output:29</span><br></pre></td></tr></table></figure></p>
<p><img src="/myimages/5AF130BA8D72133620497836ECF600F5.png" alt="dd.png"></p>
<p>这个算是额外记录，从vm1 -&gt; fip流量直接在br-int转发搞定，但是从br-int回来的流量，却经过br-ex后从外网桥转回，也就是来回路径并不相同</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://vcpu.me/dragonflow_provider_flow/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="vcpu.me">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/h.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="i博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/dragonflow_provider_flow/" itemprop="url">dragonflow provider流量走向图示</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-09T18:00:00+08:00">
                2018-04-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dragonflow/" itemprop="url" rel="index">
                    <span itemprop="name">dragonflow</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/dragonflow_provider_flow/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="dragonflow_provider_flow/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/dragonflow_provider_flow/" class="leancloud_visitors" data-flag-title="dragonflow provider流量走向图示">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="ARP"><a href="#ARP" class="headerlink" title="ARP"></a>ARP</h1><p>dragonflow provider arp处理分按照代理和非代理两种，代理是指controller负责回复，非代理是指云主机直接回复</p>
<p>arp代理是由控制节点的流表，所有的云主机的arp请求数据包，会被拦截回复；dragonflow要求所有的云主机arp均由它自己拦截arp请求并回复；如果没有被拦截的arp请求被判定为非云主机地址，会被发给外网网桥。</p>
<p>针对于从外网发进来的arp流量，会根据目的mac进行匹配，如果这些流量是云主机的mac会负责将该流量转发给具体的云主机，如果无法识别mac，就在table75被丢弃</p>
<h2 id="vm1-arping-gw"><a href="#vm1-arping-gw" class="headerlink" title="vm1 arping gw "></a>vm1 arping gw </h2><h3 id="广播"><a href="#广播" class="headerlink" title="广播"></a>广播</h3><p><img src="/myimages/189ED732C8C1221E18AA59713E29007E.png" alt="dd.png"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cookie=0x0, duration=607.261s, table=0, n_packets=538, n_bytes=22596, idle_age=0, priority=100,in_port=16 actions=load:0x7d-&gt;NXM_NX_REG6[],load:0x7-&gt;OXM_OF_METADATA[],load:0-&gt;OXM_OF_IN_PORT[],resubmit(,)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=647.825s, table=0, n_packets=1102, n_bytes=47508, idle_age=0, priority=1 actions=resubmit(,5)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=654.478s, table=5, n_packets=583, n_bytes=24486, idle_age=0, priority=200,arp,reg6=0x7d,dl_src=fa:16:3e:21:be:e8,arp_spa=192.168.56.53,arp_sha=fa:16:3e:21:be:e8 actions=resubmit(,20)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=665.119s, table=20, n_packets=589, n_bytes=24738, idle_age=0, priority=100,arp actions=resubmit(,25)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=672.231s, table=25, n_packets=596, n_bytes=25032, idle_age=0, priority=1 actions=resubmit(,55)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=689.054s, table=55, n_packets=728, n_bytes=34097, idle_age=0, hard_age=688, priority=100,metadata=0x7,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00 actions=load:0x7f-&gt;NXM_NX_REG7[],resubmit(,75),load:0x7d-&gt;NXM_NX_REG7[],resubmit(,75),load:0-&gt;NXM_NX_REG7[],resubmit(,75)</span><br></pre></td></tr></table></figure></p>
<p>广播流量路径：vm1(drop) vm2 default<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cookie=0x0, duration=770.378s, table=75, n_packets=698, n_bytes=29316, idle_age=1, priority=200,reg6=0x7d,reg7=0x7d,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00 actions=drop</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=777.680s, table=75, n_packets=818, n_bytes=37945, idle_age=1, priority=100,reg7=0x7f actions=resubmit(,105)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=733.759s, table=75, n_packets=662, n_bytes=27804, idle_age=0, priority=50,metadata=0x7 actions=resubmit(,80)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=742.917s, table=80, n_packets=671, n_bytes=28182, idle_age=0, priority=100,metadata=0x7 actions=output:1</span><br></pre></td></tr></table></figure></p>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cookie=0x0, duration=923.834s, table=0, n_packets=1026, n_bytes=63133, idle_age=1, priority=50,in_port=1,vlan_tci=0x0000/0x1fff actions=load:0-&gt;OXM_OF_IN_PORT[],load:0x7-&gt;OXM_OF_METADATA[],load:0x64-&gt;NXM_NX_REG8[],resubmit(,2)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=944.640s, table=2, n_packets=1043, n_bytes=64153, idle_age=0, priority=1 actions=resubmit(,55)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=965.539s, table=55, n_packets=894, n_bytes=53640, idle_age=0, priority=100,metadata=0x7,dl_dst=fa:16:3e:21:be:e8 actions=load:0x7d-&gt;NXM_NX_REG7[],resubmit(,75)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=1023.530s, table=75, n_packets=1081, n_bytes=66433, idle_age=0, priority=100,reg7=0x7d actions=resubmit(,105)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=1064.648s, table=105, n_packets=2236, n_bytes=116376, idle_age=0, priority=1 actions=resubmit(,115)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=1101.283s, table=115, n_packets=1170, n_bytes=70200, idle_age=0, priority=100,reg7=0x7d actions=output:16</span><br></pre></td></tr></table></figure>
<p>从云主机发出的arp广播流量，送给table75，因为是广播流量，将该广播数据包复制给 同一个网段的云主机和复制给br-ex连接的patch口</p>
<p>针对于非flat外网？ 广播是如何处理的？</p>
<h3 id="单播"><a href="#单播" class="headerlink" title="单播"></a>单播</h3><p><img src="/myimages/2F68680D864F6110CF0BDE1DA482D209.png" alt="dd.png"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cookie=0x0, duration=1601.401s, table=0, n_packets=1528, n_bytes=64176, idle_age=0, priority=100,in_port=16 actions=load:0x7d-&gt;NXM_NX_REG6[],load:0x7-&gt;OXM_OF_METADATA[],load:0-&gt;OXM_OF_IN_PORT[],resubmit(,)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=1623.738s, table=0, n_packets=2073, n_bytes=88290, idle_age=1, priority=1 actions=resubmit(,5)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=1631.400s, table=5, n_packets=1555, n_bytes=65310, idle_age=1, priority=200,arp,reg6=0x7d,dl_src=fa:16:3e:21:be:e8,arp_spa=192.168.56.53,arp_sha=fa:16:3e:21:be:e8 actions=resubmit(,20)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=1644.069s, table=20, n_packets=1564, n_bytes=65688, idle_age=0, priority=100,arp actions=resubmit(,25)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=1665.411s, table=25, n_packets=1585, n_bytes=66570, idle_age=0, priority=1 actions=resubmit(,55)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=1700.542s, table=55, n_packets=639, n_bytes=30510, idle_age=1, priority=70,metadata=0x7,dl_dst=00:00:00:00:00:00/01:00:00:00:00:00 actions=resubmit(,75)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=1765.619s, table=75, n_packets=1690, n_bytes=70980, idle_age=0, priority=50,metadata=0x7 actions=resubmit(,80)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=1803.244s, table=80, n_packets=1727, n_bytes=72534, idle_age=0, priority=100,metadata=0x7 actions=output:1</span><br></pre></td></tr></table></figure></p>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cookie=0x0, duration=1817.453s, table=0, n_packets=2198, n_bytes=135047, idle_age=0, priority=50,in_port=1,vlan_tci=0x0000/0x1fff actions=load:0-&gt;OXM_OF_IN_PORT[],load:0x7-&gt;OXM_OF_METADATA[],load:0x64-&gt;NXM_NX_REG8[],resubmit(,2)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=1830.150s, table=2, n_packets=2206, n_bytes=135527, idle_age=1, priority=1 actions=resubmit(,55)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=1840.858s, table=55, n_packets=1765, n_bytes=105900, idle_age=0, priority=100,metadata=0x7,dl_dst=fa:16:3e:21:be:e8 actions=load:0x7d-&gt;NXM_NX_REG7[],resubmit(,75)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=1856.090s, table=75, n_packets=2033, n_bytes=125147, idle_age=0, priority=100,reg7=0x7d actions=resubmit(,105)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=1876.903s, table=105, n_packets=3461, n_bytes=186258, idle_age=0, priority=1 actions=resubmit(,115)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=1881.039s, table=115, n_packets=2044, n_bytes=122640, idle_age=0, priority=100,reg7=0x7d actions=output:16</span><br></pre></td></tr></table></figure>
<h2 id="vm1-arping-qg"><a href="#vm1-arping-qg" class="headerlink" title="vm1 arping qg"></a>vm1 arping qg</h2><p><img src="/myimages/80BEA1A2C1013277B0C54E54CA859B13.png" alt="dd.png"></p>
<h3 id="广播／单播"><a href="#广播／单播" class="headerlink" title="广播／单播"></a>广播／单播</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cookie=0x0, duration=2056.929s, table=0, n_packets=1966, n_bytes=82572, idle_age=0, priority=100,in_port=16 actions=load:0x7d-&gt;NXM_NX_REG6[],load:0x7-&gt;OXM_OF_METADATA[],load:0-&gt;OXM_OF_IN_PORT[],resubmit(,)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2114.828s, table=0, n_packets=2547, n_bytes=108198, idle_age=0, priority=1 actions=resubmit(,5)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2118.433s, table=5, n_packets=2025, n_bytes=85050, idle_age=0, priority=200,arp,reg6=0x7d,dl_src=fa:16:3e:21:be:e8,arp_spa=192.168.56.53,arp_sha=fa:16:3e:21:be:e8 actions=resubmit(,20)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2133.137s, table=20, n_packets=2035, n_bytes=85470, idle_age=0, priority=100,arp actions=resubmit(,25)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2138.258s, table=25, n_packets=161, n_bytes=6762, idle_age=1, priority=100,arp,metadata=0x7,arp_tpa=192.168.56.60,arp_op=1 actions=load:0x2-&gt;NXM_OF_ARP_OP[],move:NXM_NX_ARP_SHA[]-&gt;NXM_NX_ARP_THA[],move:NXM_OF_ARP_SPA[]-&gt;NXM_OF_ARP_TPA[],move:NXM_OF_E</span><br><span class="line"></span><br><span class="line">TH_SRC[]-&gt;NXM_OF_ETH_DST[],mod_dl_src:fa:16:3e:41:ef:d4,load:0xfa163e41efd4-&gt;NXM_NX_ARP_SHA[],load:0xc0a8383c-&gt;NXM_OF_ARP_SPA[],move:NXM_NX_REG6[]-&gt;NXM_NX_REG7[],resubmit(,115)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2162.722s, table=115, n_packets=2352, n_bytes=137754, idle_age=0, priority=100,reg7=0x7d actions=output:16</span><br></pre></td></tr></table></figure>
<p>vm1 — controller — qg</p>
<p> 云主机的arp流量景观table25 转接后，直接将会应数据包，将该数据吧发给该云主机</p>
<h2 id="vm1-arping-vm2"><a href="#vm1-arping-vm2" class="headerlink" title="vm1 arping vm2"></a>vm1 arping vm2</h2><p><img src="/myimages/80BEA1A2C1013277B0C54E54CA859B13.png" alt="dd.png"></p>
<h3 id="广播-1"><a href="#广播-1" class="headerlink" title="广播"></a>广播</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cookie=0x0, duration=2399.594s, table=0, n_packets=2273, n_bytes=95466, idle_age=0, priority=100,in_port=16 actions=load:0x7d-&gt;NXM_NX_REG6[],load:0x7-&gt;OXM_OF_METADATA[],load:0-&gt;OXM_OF_IN_PORT[],resubmit(,)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2425.953s, table=0, n_packets=2822, n_bytes=119748, idle_age=0, priority=1 actions=resubmit(,5)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2431.584s, table=5, n_packets=2302, n_bytes=96684, idle_age=0, priority=200,arp,reg6=0x7d,dl_src=fa:16:3e:21:be:e8,arp_spa=192.168.56.53,arp_sha=fa:16:3e:21:be:e8 actions=resubmit(,20)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=2449.325s, table=20, n_packets=2315, n_bytes=97230, idle_age=1, priority=100,arp actions=resubmit(,25)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2452.901s, table=25, n_packets=91, n_bytes=3822, idle_age=1, priority=100,arp,metadata=0x7,arp_tpa=192.168.56.62,arp_op=1 actions=load:0x2-&gt;NXM_OF_ARP_OP[],move:NXM_NX_ARP_SHA[]-&gt;NXM_NX_ARP_THA[],move:NXM_OF_ARP_SPA[]-&gt;NXM_OF_ARP_TPA[],move:NXM_OF_ETH_SRC[]-&gt;NXM_OF_ETH_DST[],mod_dl_src:fa:16:3e:26:36:07,load:0xfa163e263607-&gt;NXM_NX_ARP_SHA[],load:0xc0a8383e-&gt;NXM_OF_ARP_SPA[],move:NXM_NX_REG6[]-&gt;NXM_NX_REG7[],resubmit(,115)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=2476.824s, table=115, n_packets=2695, n_bytes=153330, idle_age=0, priority=100,reg7=0x7d actions=output:16</span><br></pre></td></tr></table></figure>
<p>vm1 — controller — vm1</p>
<p> 云主机的arp流量景观table25 转接后，直接将会应数据包，将该数据吧发给该云主机</p>
<h2 id="gw-arping-vm1"><a href="#gw-arping-vm1" class="headerlink" title="gw arping vm1"></a>gw arping vm1</h2><p><img src="/myimages/AD51264EDEABA3ADF7B2577CD22EA379.png" alt="dd.png"></p>
<h3 id="广播-2"><a href="#广播-2" class="headerlink" title="广播"></a>广播</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cookie=0x0, duration=2797.647s, table=0, n_packets=2727, n_bytes=168129, idle_age=0, priority=50,in_port=1,vlan_tci=0x0000/0x1fff actions=load:0-&gt;OXM_OF_IN_PORT[],load:0x7-&gt;OXM_OF_METADATA[],load:0x64-&gt;NXM_NX_REG8[],resubmit(,2)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2828.673s, table=2, n_packets=2753, n_bytes=169689, idle_age=1, priority=1 actions=resubmit(,55)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2852.608s, table=55, n_packets=1742, n_bytes=87627, idle_age=0, hard_age=2851, priority=100,metadata=0x7,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00 actions=load:0x7f-&gt;NXM_NX_REG7[],resubmit(,75),load:0x7d-&gt;NXM_NX_REG7[],resubmit(,75),load:0-&gt;NXM_NX_REG7[],resubmit(,75)</span><br></pre></td></tr></table></figure>
<p>vm1 ,vm2，default<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> cookie=0x0, duration=3043.548s, table=75, n_packets=2629, n_bytes=162259, idle_age=1, priority=100,reg7=0x7d actions=resubmit(,105) 发给vm</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=3084.365s, table=75, n_packets=1992, n_bytes=102637, idle_age=0, priority=100,reg7=0x7f actions=resubmit(,105) 发给vm</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=3110.547s, table=75, n_packets=1186, n_bytes=75679, idle_age=0, priority=51,reg6=0,metadata=0x7 actions=drop 要广播给外网在此丢弃</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=3150.668s, table=105, n_packets=4789, n_bytes=265938, idle_age=0, priority=1 actions=resubmit(,115)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=3150.738s, table=115, n_packets=3308, n_bytes=188364, idle_age=0, priority=100,reg7=0x7d actions=output:16</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=3150.726s, table=115, n_packets=2055, n_bytes=101898, idle_age=0, priority=100,reg7=0x7f actions=output:22</span><br></pre></td></tr></table></figure></p>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> cookie=0x0, duration=3183.224s, table=0, n_packets=505, n_bytes=21210, idle_age=0, priority=100,in_port=22 actions=load:0x7f-&gt;NXM_NX_REG6[],load:0x7-&gt;OXM_OF_METADATA[],load:0-&gt;OXM_OF_IN_PORT[],resubmit(,)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=3234.066s, table=0, n_packets=3526, n_bytes=149316, idle_age=0, priority=1 actions=resubmit(,5)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=3241.916s, table=5, n_packets=562, n_bytes=23604, idle_age=0, priority=200,arp,reg6=0x7f,dl_src=fa:16:3e:26:36:07,arp_spa=192.168.56.62,arp_sha=fa:16:3e:26:36:07 actions=resubmit(,20)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=3267.624s, table=20, n_packets=3029, n_bytes=127218, idle_age=1, priority=100,arp actions=resubmit(,25)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=3273.763s, table=25, n_packets=2473, n_bytes=103866, idle_age=1, priority=1 actions=resubmit(,55)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=3315.921s, table=55, n_packets=1733, n_bytes=80022, idle_age=0, priority=70,metadata=0x7,dl_dst=00:00:00:00:00:00/01:00:00:00:00:00 actions=resubmit(,75) 单播流量发给外网</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=3340.281s, table=75, n_packets=2544, n_bytes=106848, idle_age=1, priority=50,metadata=0x7 actions=resubmit(,80)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=3347.397s, table=80, n_packets=2551, n_bytes=107142, idle_age=1, priority=100,metadata=0x7 actions=output:1</span><br></pre></td></tr></table></figure>
<h3 id="单播-1"><a href="#单播-1" class="headerlink" title="单播"></a>单播</h3><p><img src="/myimages/F843F957B30780E39831EC6A5E2BC013.png" alt="dd.png"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cookie=0x0, duration=3547.656s, table=0, n_packets=3734, n_bytes=228559, idle_age=0, priority=50,in_port=1,vlan_tci=0x0000/0x1fff actions=load:0-&gt;OXM_OF_IN_PORT[],load:0x7-&gt;OXM_OF_METADATA[],load:0x64-&gt;NXM_NX_REG8[],resubmit(,2)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=3563.403s, table=2, n_packets=3748, n_bytes=229399, idle_age=0, priority=1 actions=resubmit(,55)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=3606.613s, table=55, n_packets=86, n_bytes=5160, idle_age=0, priority=100,metadata=0x7,dl_dst=fa:16:3e:26:36:07 actions=load:0x7f-&gt;NXM_NX_REG7[],resubmit(,75)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=3625.110s, table=75, n_packets=2641, n_bytes=141577, idle_age=0, priority=100,reg7=0x7f actions=resubmit(,105)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=3650.798s, table=105, n_packets=5861, n_bytes=330258, idle_age=0, priority=1 actions=resubmit(,115)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=3664.045s, table=115, n_packets=2668, n_bytes=138678, idle_age=0, priority=100,reg7=0x7f actions=output:22</span><br></pre></td></tr></table></figure></p>
<p>从外网流入内网，根据目的mac判定要发给云主机的reg7，然后再具体output到22口</p>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> cookie=0x0, duration=3700.659s, table=0, n_packets=1020, n_bytes=42840, idle_age=0, priority=100,in_port=22 actions=load:0x7f-&gt;NXM_NX_REG6[],load:0x7-&gt;OXM_OF_METADATA[],load:0-&gt;OXM_OF_IN_PORT[],resubmit(,)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=3717.888s, table=0, n_packets=4007, n_bytes=169518, idle_age=0, priority=1 actions=resubmit(,5)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=3724.775s, table=5, n_packets=1042, n_bytes=43764, idle_age=1, priority=200,arp,reg6=0x7f,dl_src=fa:16:3e:26:36:07,arp_spa=192.168.56.62,arp_sha=fa:16:3e:26:36:07 actions=resubmit(,20)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=3753.486s, table=20, n_packets=3513, n_bytes=147546, idle_age=0, priority=100,arp actions=resubmit(,25)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=3765.676s, table=25, n_packets=2963, n_bytes=124446, idle_age=0, priority=1 actions=resubmit(,55)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=3834.332s, table=55, n_packets=2354, n_bytes=108084, idle_age=0, priority=70,metadata=0x7,dl_dst=00:00:00:00:00:00/01:00:00:00:00:00 actions=resubmit(,75)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=3855.686s, table=75, n_packets=3052, n_bytes=128184, idle_age=0, priority=50,metadata=0x7 actions=resubmit(,80)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=3875.989s, table=80, n_packets=3072, n_bytes=129024, idle_age=1, priority=100,metadata=0x7 actions=output:1</span><br></pre></td></tr></table></figure>
<p> 向外发包单播</p>
<h2 id="qg-arping-vm1"><a href="#qg-arping-vm1" class="headerlink" title="qg arping vm1"></a>qg arping vm1</h2><h3 id="广播-3"><a href="#广播-3" class="headerlink" title="广播"></a>广播</h3><p>外网发给云主机方向流量<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cookie=0x0, duration=4174.765s, table=0, n_packets=4364, n_bytes=266842, idle_age=0, priority=50,in_port=1,vlan_tci=0x0000/0x1fff actions=load:0-&gt;OXM_OF_IN_PORT[],load:0x7-&gt;OXM_OF_METADATA[],load:0x64-&gt;NXM_NX_REG8[],resubmit(,2)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=4203.729s, table=2, n_packets=4388, n_bytes=267850, idle_age=0, priority=1 actions=resubmit(,55)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=4225.600s, table=55, n_packets=2664, n_bytes=142522, idle_age=0, hard_age=4224, priority=100,metadata=0x7,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00 actions=load:0x7f-&gt;NXM_NX_REG7[],resubmit(,75),load:0x7d-&gt;NXM_NX_REG7[],resubmit(,75),load:0-&gt;NXM_NX_REG7[],resubmit(,75)</span><br></pre></td></tr></table></figure></p>
<p>vm1 vm2 外网<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cookie=0x0, duration=4264.216s, table=75, n_packets=3405, n_bytes=207700, idle_age=0, priority=100,reg7=0x7d actions=resubmit(,105) vm1</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=4277.591s, table=75, n_packets=3280, n_bytes=178546, idle_age=1, priority=100,reg7=0x7f actions=resubmit(,105). vm2</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=4313.952s, table=75, n_packets=2112, n_bytes=129220, idle_age=0, priority=51,reg6=0,metadata=0x7 actions=drop 丢弃外网数据</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=4493.285s, table=105, n_packets=7169, n_bytes=395490, idle_age=0, priority=1 actions=resubmit(,115)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=4497.412s, table=115, n_packets=4230, n_bytes=236844, idle_age=0, priority=100,reg7=0x7d actions=output:16</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=4497.399s, table=115, n_packets=3523, n_bytes=183138, idle_age=0, priority=100,reg7=0x7f actions=output:22</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=4666.052s, table=55, n_packets=547, n_bytes=22974, idle_age=0, priority=100,metadata=0x7,dl_dst=fa:16:3e:41:ef:d4 actions=load:0x25-&gt;NXM_NX_REG7[],resubmit(,75)</span><br></pre></td></tr></table></figure></p>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cookie=0x0, duration=4515.693s, table=0, n_packets=1788, n_bytes=75096, idle_age=0, priority=100,in_port=22 actions=load:0x7f-&gt;NXM_NX_REG6[],load:0x7-&gt;OXM_OF_METADATA[],load:0-&gt;OXM_OF_IN_PORT[],resubmit(,)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=4539s, table=0, n_packets=4781, n_bytes=202026, idle_age=0, priority=1 actions=resubmit(,5)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=4547.893s, table=5, n_packets=1818, n_bytes=76356, idle_age=0, priority=200,arp,reg6=0x7f,dl_src=fa:16:3e:26:36:07,arp_spa=192.168.56.62,arp_sha=fa:16:3e:26:36:07 actions=resubmit(,20)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=4559.372s, table=20, n_packets=4271, n_bytes=179382, idle_age=0, priority=100,arp actions=resubmit(,25)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=4569.552s, table=25, n_packets=3719, n_bytes=156198, idle_age=1, priority=1 actions=resubmit(,55)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=4737.192s, table=55, n_packets=618, n_bytes=25956, idle_age=0, priority=100,metadata=0x7,dl_dst=fa:16:3e:41:ef:d4 actions=load:0x25-&gt;NXM_NX_REG7[],resubmit(,75)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=4601.053s, table=75, n_packets=482, n_bytes=20244, idle_age=0, priority=100,reg7=0x25 actions=resubmit(,80)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=4612.758s, table=80, n_packets=3767, n_bytes=158214, idle_age=0, priority=100,metadata=0x7 actions=output:1</span><br></pre></td></tr></table></figure>
<h3 id="单播-2"><a href="#单播-2" class="headerlink" title="单播"></a>单播</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cookie=0x0, duration=4799.759s, table=0, n_packets=5245, n_bytes=309830, idle_age=0, priority=50,in_port=1,vlan_tci=0x0000/0x1fff actions=load:0-&gt;OXM_OF_IN_PORT[],load:0x7-&gt;OXM_OF_METADATA[],load:0x64-&gt;NXM_NX_REG8[],resubmit(,2)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=4812.432s, table=2, n_packets=5253, n_bytes=310166, idle_age=0, priority=1 actions=resubmit(,55)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=4835.325s, table=55, n_packets=602, n_bytes=35202, idle_age=1, priority=100,metadata=0x7,dl_dst=fa:16:3e:26:36:07 actions=load:0x7f-&gt;NXM_NX_REG7[],resubmit(,75)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=4848.726s, table=75, n_packets=3955, n_bytes=210128, idle_age=0, priority=100,reg7=0x7f actions=resubmit(,105)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=4869.354s, table=105, n_packets=7946, n_bytes=430068, idle_age=0, priority=1 actions=resubmit(,115)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=4870.397s, table=115, n_packets=3948, n_bytes=201960, idle_age=0, priority=100,reg7=0x7f actions=output:22</span><br></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cookie=0x0, duration=4883.625s, table=0, n_packets=2154, n_bytes=90468, idle_age=0, priority=100,in_port=22 actions=load:0x7f-&gt;NXM_NX_REG6[],load:0x7-&gt;OXM_OF_METADATA[],load:0-&gt;OXM_OF_IN_PORT[],resubmit(,)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=4915.097s, table=0, n_packets=5155, n_bytes=217734, idle_age=1, priority=1 actions=resubmit(,5)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=4918.884s, table=5, n_packets=2187, n_bytes=91854, idle_age=1, priority=200,arp,reg6=0x7f,dl_src=fa:16:3e:26:36:07,arp_spa=192.168.56.62,arp_sha=fa:16:3e:26:36:07 actions=resubmit(,20)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=4934.423s, table=20, n_packets=4645, n_bytes=195090, idle_age=0, priority=100,arp actions=resubmit(,25)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=4948.657s, table=25, n_packets=4097, n_bytes=172074, idle_age=0, priority=1 actions=resubmit(,55)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=4964.890s, table=55, n_packets=845, n_bytes=35490, idle_age=0, priority=100,metadata=0x7,dl_dst=fa:16:3e:41:ef:d4 actions=load:0x25-&gt;NXM_NX_REG7[],resubmit(,75)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=5000.459s, table=75, n_packets=880, n_bytes=36960, idle_age=0, priority=100,reg7=0x25 actions=resubmit(,80)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=5013.163s, table=80, n_packets=4166, n_bytes=174972, idle_age=0, priority=100,metadata=0x7 actions=output:1</span><br></pre></td></tr></table></figure>
<h1 id="IP"><a href="#IP" class="headerlink" title="IP"></a>IP</h1><p>云主机访问外网，会走默认策略（根据单播）判别，默认是外网网段，发给外网网口</p>
<h2 id="vm1-ping-qg"><a href="#vm1-ping-qg" class="headerlink" title="vm1 ping qg"></a>vm1 ping qg</h2><p><img src="/myimages/CC91CC36BA7D817EFADD7E867EB23488.png" alt="dd.png"></p>
<p>在l2根据目的mac判别，如果是qg地址，就将流量发给外网<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cookie=0x0, duration=914.122s, table=0, n_packets=139, n_bytes=13174, idle_age=0, priority=100,in_port=16 actions=load:0x7d-&gt;NXM_NX_REG6[],load:0x7-&gt;OXM_OF_METADATA[],load:0-&gt;OXM_OF_IN_PORT[],resubmit(,)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=926.621s, table=0, n_packets=392, n_bytes=33376, idle_age=1, priority=1 actions=resubmit(,5)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=937.802s, table=5, n_packets=154, n_bytes=15092, idle_age=1, priority=200,ip,reg6=0x7d,dl_src=fa:16:3e:21:be:e8,nw_src=192.168.56.53 actions=resubmit(,10)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=952.053s, table=10, n_packets=169, n_bytes=16562, idle_age=0, priority=100,ip,reg6=0x7d actions=ct(table=15,zone=OXM_OF_METADATA[0..15])</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=970.383s, table=15, n_packets=264, n_bytes=25872, idle_age=0, priority=65534,ct_state=-new+est-rel-inv+trk actions=resubmit(,20)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=982.595s, table=20, n_packets=359, n_bytes=35182, idle_age=0, priority=1 actions=resubmit(,55)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=1010.847s, table=55, n_packets=234, n_bytes=22596, idle_age=0, priority=100,metadata=0x7,dl_dst=fa:16:3e:41:ef:d4 actions=load:0x25-&gt;NXM_NX_REG7[],resubmit(,75)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=1120.621s, table=75, n_packets=343, n_bytes=33110, idle_age=0, priority=100,reg7=0x25 actions=resubmit(,80)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=1129.899s, table=80, n_packets=352, n_bytes=33992, idle_age=1, priority=100,metadata=0x7 actions=output:1</span><br></pre></td></tr></table></figure></p>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> cookie=0x0, duration=1153.258s, table=0, n_packets=661, n_bytes=55121, idle_age=0, priority=50,in_port=1,vlan_tci=0x0000/0x1fff actions=load:0-&gt;OXM_OF_IN_PORT[],load:0x7-&gt;OXM_OF_METADATA[],load:0x64-&gt;NXM_NX_REG8[],resubmit(,2)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=1163.459s, table=2, n_packets=668, n_bytes=55807, idle_age=0, priority=1 actions=resubmit(,55)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=1179.678s, table=55, n_packets=404, n_bytes=38976, idle_age=0, priority=100,metadata=0x7,dl_dst=fa:16:3e:21:be:e8 actions=load:0x7d-&gt;NXM_NX_REG7[],resubmit(,75)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=1196.945s, table=75, n_packets=561, n_bytes=50719, idle_age=0, priority=100,reg7=0x7d actions=resubmit(,105)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=1218.256s, table=105, n_packets=436, n_bytes=44139, idle_age=1, priority=100,ip,reg7=0x7d actions=ct(table=110,zone=OXM_OF_METADATA[0..15])</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=1231.491s, table=110, n_packets=523, n_bytes=51254, idle_age=1, priority=65534,ct_state=-new+est-rel-inv+trk actions=resubmit(,115)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=1260.884s, table=115, n_packets=657, n_bytes=56892, idle_age=0, priority=100,reg7=0x7d actions=output:16</span><br></pre></td></tr></table></figure>
<h3 id="vm1-ping-gw"><a href="#vm1-ping-gw" class="headerlink" title="vm1 ping gw"></a>vm1 ping gw</h3><p><img src="/myimages/684AFF754B1D1EB1D8FBAFC403579A21.png" alt="dd.png"></p>
<p>如果被访问的节点属于单播，table55在处理其时候，会将该流量交给table75进行路径选择，该流量最终会交给外网发出（因为没有设置标记该流量肯定不在内网节点中）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cookie=0x0, duration=2609.046s, table=0, n_packets=1778, n_bytes=168644, idle_age=0, priority=100,in_port=16 actions=load:0x7d-&gt;NXM_NX_REG6[],load:0x7-&gt;OXM_OF_METADATA[],load:0-&gt;OXM_OF_IN_PORT[],resubmit(,)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2627.708s, table=0, n_packets=2036, n_bytes=189392, idle_age=0, priority=1 actions=resubmit(,5)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2634.802s, table=5, n_packets=1703, n_bytes=166894, idle_age=1, priority=200,ip,reg6=0x7d,dl_src=fa:16:3e:21:be:e8,nw_src=192.168.56.53 actions=resubmit(,10)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2642.923s, table=10, n_packets=1711, n_bytes=167678, idle_age=1, priority=100,ip,reg6=0x7d actions=ct(table=15,zone=OXM_OF_METADATA[0..15])</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2665.294s, table=15, n_packets=1809, n_bytes=177282, idle_age=0, priority=65534,ct_state=-new+est-rel-inv+trk actions=resubmit(,20)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2675.464s, table=20, n_packets=1903, n_bytes=186494, idle_age=0, priority=1 actions=resubmit(,55)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2694.717s, table=55, n_packets=600, n_bytes=44410, idle_age=0, priority=70,metadata=0x7,dl_dst=00:00:00:00:00:00/01:00:00:00:00:00 actions=resubmit(,75)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=2720.125s, table=75, n_packets=266, n_bytes=25284, idle_age=1, priority=50,metadata=0x7 actions=resubmit(,80)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2726.210s, table=80, n_packets=1853, n_bytes=178346, idle_age=0, priority=100,metadata=0x7 actions=output:1</span><br></pre></td></tr></table></figure></p>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> cookie=0x0, duration=2737.383s, table=0, n_packets=2612, n_bytes=227898, idle_age=0, priority=50,in_port=1,vlan_tci=0x0000/0x1fff actions=load:0-&gt;OXM_OF_IN_PORT[],load:0x7-&gt;OXM_OF_METADATA[],load:0x64-&gt;NXM_NX_REG8[],resubmit(,2)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2747.577s, table=2, n_packets=2625, n_bytes=229756, idle_age=0, priority=1 actions=resubmit(,55)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2758.738s, table=55, n_packets=1887, n_bytes=181854, idle_age=0, priority=100,metadata=0x7,dl_dst=fa:16:3e:21:be:e8 actions=load:0x7d-&gt;NXM_NX_REG7[],resubmit(,75)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=2773.966s, table=75, n_packets=2282, n_bytes=210278, idle_age=0, priority=100,reg7=0x7d actions=resubmit(,105)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2786.128s, table=105, n_packets=1869, n_bytes=186632, idle_age=1, priority=100,ip,reg7=0x7d actions=ct(table=110,zone=OXM_OF_METADATA[0..15])</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2802.404s, table=110, n_packets=1949, n_bytes=191002, idle_age=1, priority=65534,ct_state=-new+est-rel-inv+trk actions=resubmit(,115)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2816.284s, table=115, n_packets=2355, n_bytes=211292, idle_age=0, priority=100,reg7=0x7d actions=output:16</span><br></pre></td></tr></table></figure>
<h3 id="vm1-ping-vm2"><a href="#vm1-ping-vm2" class="headerlink" title="vm1 ping vm2"></a>vm1 ping vm2</h3><p><img src="/myimages/2133ABF4F49EC90FB27EF93CE55A4229.png" alt="dd.png"></p>
<p>其实这部分包含两种情况，这里只展示了一种情况，就是两个provider的云主机在同一个计算节点的br-int上；</p>
<p>另外一种情况是，vm2位于另一个桥上；那么处理有什么差别？</p>
<p> 流量流经table55会按照目的mac进行查找，因为远程主机的mac也含有表项目，也可以查找流量路径标记</p>
<p> 但是table75并没有针对于该流量路径标记的处理，该流量会走默认处理路径（被交给外网处理）</p>
<h3 id="gw-ping-vm1"><a href="#gw-ping-vm1" class="headerlink" title="gw ping vm1"></a>gw ping vm1</h3><p>根据mac查找具体的云主机<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cookie=0x0, duration=1713.178s, table=0, n_packets=591, n_bytes=46402, idle_age=0, priority=50,in_port=1,vlan_tci=0x0000/0x1fff actions=load:0-&gt;OXM_OF_IN_PORT[],load:0x7-&gt;OXM_OF_METADATA[],load:0x64-&gt;NXM_NX_REG8[],resubmit(,2)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=1726.168s, table=2, n_packets=604, n_bytes=47638, idle_age=0, priority=1 actions=resubmit(,55)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=1746.737s, table=55, n_packets=1232, n_bytes=120356, idle_age=0, priority=100,metadata=0x7,dl_dst=fa:16:3e:21:be:e8 actions=load:0x7d-&gt;NXM_NX_REG7[],resubmit(,75)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=1772.110s, table=75, n_packets=1434, n_bytes=136768, idle_age=0, priority=100,reg7=0x7d actions=resubmit(,105)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=1790.411s, table=105, n_packets=1278, n_bytes=127978, idle_age=0, priority=100,ip,reg7=0x7d actions=ct(table=110,zone=OXM_OF_METADATA[0..15])</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=1805.436s, table=110, n_packets=2266, n_bytes=222068, idle_age=0, priority=65534,ct_state=-new+est-rel-inv+trk actions=resubmit(,115)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=1816.578s, table=115, n_packets=1511, n_bytes=139016, idle_age=0, priority=100,reg7=0x7d actions=output:16</span><br></pre></td></tr></table></figure></p>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> cookie=0x0, duration=1834.912s, table=0, n_packets=1361, n_bytes=130466, idle_age=0, priority=100,in_port=16 actions=load:0x7d-&gt;NXM_NX_REG6[],load:0x7-&gt;OXM_OF_METADATA[],load:0-&gt;OXM_OF_IN_PORT[],resubmit(,)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=1846.134s, table=0, n_packets=2771, n_bytes=245630, idle_age=1, priority=1 actions=resubmit(,5)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=1856.520s, table=5, n_packets=1331, n_bytes=130438, idle_age=0, priority=200,ip,reg6=0x7d,dl_src=fa:16:3e:21:be:e8,nw_src=192.168.56.53 actions=resubmit(,10)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=1866.695s, table=10, n_packets=1341, n_bytes=131418, idle_age=0, priority=100,ip,reg6=0x7d actions=ct(table=15,zone=OXM_OF_METADATA[0..15])</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=1878.661s, table=15, n_packets=2340, n_bytes=229320, idle_age=0, priority=65534,ct_state=-new+est-rel-inv+trk actions=resubmit(,20)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=1888.822s, table=20, n_packets=2351, n_bytes=230398, idle_age=0, priority=1 actions=resubmit(,55)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=1903.248s, table=55, n_packets=652, n_bytes=53594, idle_age=0, priority=70,metadata=0x7,dl_dst=00:00:00:00:00:00/01:00:00:00:00:00 actions=resubmit(,75)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=1937.775s, table=75, n_packets=439, n_bytes=42070, idle_age=0, priority=50,metadata=0x7 actions=resubmit(,80)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=1943.869s, table=80, n_packets=445, n_bytes=42658, idle_age=0, priority=100,metadata=0x7 actions=output:1</span><br></pre></td></tr></table></figure>
<h3 id="qg-ping-vm1"><a href="#qg-ping-vm1" class="headerlink" title="qg ping vm1"></a>qg ping vm1</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cookie=0x0, duration=2195s, table=0, n_packets=1201, n_bytes=98278, idle_age=6, priority=50,in_port=1,vlan_tci=0x0000/0x1fff actions=load:0-&gt;OXM_OF_IN_PORT[],load:0x7-&gt;OXM_OF_METADATA[],load:0x64-&gt;NXM_NX_REG8[],resubmit(,2)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2202.007s, table=2, n_packets=1204, n_bytes=98458, idle_age=2, priority=1 actions=resubmit(,55)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2247.938s, table=55, n_packets=1637, n_bytes=159628, idle_age=0, priority=100,metadata=0x7,dl_dst=fa:16:3e:21:be:e8 actions=load:0x7d-&gt;NXM_NX_REG7[],resubmit(,75)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2276.419s, table=75, n_packets=1953, n_bytes=183032, idle_age=0, priority=100,reg7=0x7d actions=resubmit(,105)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2293.667s, table=105, n_packets=1675, n_bytes=166884, idle_age=0, priority=100,ip,reg7=0x7d actions=ct(table=110,zone=OXM_OF_METADATA[0..15])</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2310.706s, table=110, n_packets=2665, n_bytes=261170, idle_age=0, priority=65534,ct_state=-new+est-rel-inv+trk actions=resubmit(,115)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=2315.762s, table=115, n_packets=2025, n_bytes=184700, idle_age=0, priority=100,reg7=0x7d actions=output:16</span><br></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cookie=0x0, duration=2340.117s, table=0, n_packets=1774, n_bytes=170156, idle_age=1, priority=100,in_port=16 actions=load:0x7d-&gt;NXM_NX_REG6[],load:0x7-&gt;OXM_OF_METADATA[],load:0-&gt;OXM_OF_IN_PORT[],resubmit(,)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=2353.382s, table=0, n_packets=3191, n_bytes=286006, idle_age=0, priority=1 actions=resubmit(,5)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=2363.778s, table=5, n_packets=1732, n_bytes=169736, idle_age=0, priority=200,ip,reg6=0x7d,dl_src=fa:16:3e:21:be:e8,nw_src=192.168.56.53 actions=resubmit(,10)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=2372.921s, table=10, n_packets=1741, n_bytes=170618, idle_age=0, priority=100,ip,reg6=0x7d actions=ct(table=15,zone=OXM_OF_METADATA[0..15])</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=2383.859s, table=15, n_packets=2742, n_bytes=268716, idle_age=0, priority=65534,ct_state=-new+est-rel-inv+trk actions=resubmit(,20)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=2393.010s, table=20, n_packets=2753, n_bytes=269794, idle_age=1, priority=1 actions=resubmit(,55)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=2461.241s, table=55, n_packets=287, n_bytes=28126, idle_age=1, priority=100,metadata=0x7,dl_dst=fa:16:3e:41:ef:d4 actions=load:0x25-&gt;NXM_NX_REG7[],resubmit(,75)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=2475.472s, table=75, n_packets=302, n_bytes=29596, idle_age=0, priority=100,reg7=0x25 actions=resubmit(,80)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=2430.835s, table=80, n_packets=827, n_bytes=79870, idle_age=0, priority=100,metadata=0x7 actions=output:1</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://vcpu.me/dragonflow_fip_flows/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="vcpu.me">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/h.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="i博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/dragonflow_fip_flows/" itemprop="url">dragonflow fip流量走向图示</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-08T18:00:00+08:00">
                2018-04-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dragonflow/" itemprop="url" rel="index">
                    <span itemprop="name">dragonflow</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/dragonflow_fip_flows/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="dragonflow_fip_flows/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/dragonflow_fip_flows/" class="leancloud_visitors" data-flag-title="dragonflow fip流量走向图示">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="外网网关请求fip-arp流量"><a href="#外网网关请求fip-arp流量" class="headerlink" title="外网网关请求fip arp流量"></a>外网网关请求fip arp流量</h1><p><img src="/myimages/EA29465AF0F2F6F58A7D768DCFF96402.png" alt="dd.png"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cookie=0x0, duration=86.056s, table=0, n_packets=64, n_bytes=3228, idle_age=0, priority=50,in_port=1,vlan_tci=0x0000/0x1fff actions=load:0-&gt;OXM_OF_IN_PORT[],load:0x7-&gt;OXM_OF_METADATA[],load:0x64-&gt;NXM_NX_REG8[],resubmit(,2)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=185.592s, table=2, n_packets=163, n_bytes=9198, idle_age=0, priority=1 actions=resubmit(,55)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=195.967s, table=55, n_packets=174, n_bytes=9828, idle_age=0, priority=200,arp,metadata=0x7,arp_tpa=192.168.56.55,arp_op=1 actions=load:0x2-&gt;NXM_OF_ARP_OP[],move:NXM_NX_ARP_SHA[]-&gt;NXM_NX_ARP_THA[],move:NXM_OF_ARP_SPA[]-&gt;NXM_OF_ARP_TPA[],move:NXM_OF_ETH_SRC[]-&gt;NXM_OF_ETH_DST[],mod_dl_src:fa:16:3e:d4:60:2d,load:0xfa163ed4602d-&gt;NXM_NX_ARP_SHA[],load:0xc0a83837-&gt;NXM_OF_ARP_SPA[],move:NXM_NX_REG6[]-&gt;NXM_NX_REG7[],load:0x84-&gt;NXM_NX_REG6[],resubmit(,75)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=213.471s, table=75, n_packets=191, n_bytes=10848, idle_age=0, priority=50,metadata=0x7 actions=resubmit(,80)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=222.636s, table=80, n_packets=200, n_bytes=11388, idle_age=1, priority=100,metadata=0x7 actions=output:1</span><br></pre></td></tr></table></figure></p>
<p>在table55 反转ARP时候，把reg7 = 0 ，reg6 至标记fip接口标记，因为reg7是0，所以最终选择默认的路径，因为是外网网段将该数据包发给外网接口</p>
<h1 id="vm1-ping-self-fip"><a href="#vm1-ping-self-fip" class="headerlink" title="vm1 ping self fip"></a>vm1 ping self fip</h1><p><img src="/myimages/131A668728A39964A515428A0BBC017E.png" alt="dd.png"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cookie=0x0, duration=822.977s, table=0, n_packets=704, n_bytes=67984, idle_age=0, priority=100,in_port=24 actions=load:0x81-&gt;NXM_NX_REG6[],load:0x8-&gt;OXM_OF_METADATA[],load:0-&gt;OXM_OF_IN_PORT[],resubmit(,)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=840.564s, table=0, n_packets=723, n_bytes=70282, idle_age=0, priority=1 actions=resubmit(,5)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=849.699s, table=5, n_packets=712, n_bytes=69776, idle_age=1, priority=200,ip,reg6=0x81,dl_src=fa:16:3e:6c:c0:49,nw_src=1.1.1.5 actions=resubmit(,10)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=859.863s, table=10, n_packets=723, n_bytes=70854, idle_age=0, priority=100,ip,reg6=0x81 actions=ct(table=15,zone=OXM_OF_METADATA[0..15])</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=859.980s, table=15, n_packets=723, n_bytes=70854, idle_age=0, priority=6,conj_id=4,ip actions=ct(commit,table=20,zone=NXM_NX_CT_ZONE[])</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=877.145s, table=20, n_packets=737, n_bytes=72226, idle_age=0, priority=1 actions=resubmit(,55)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=959.737s, table=55, n_packets=813, n_bytes=79674, idle_age=1, priority=200,metadata=0x8,dl_dst=fa:16:3e:07:f8:41 actions=load:0x2-&gt;NXM_NX_REG5[],resubmit(,60)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=968.577s, table=60, n_packets=822, n_bytes=80556, idle_age=1, priority=70,ip,reg5=0x2,reg6=0x81,metadata=0x8,nw_src=1.1.1.5 actions=resubmit(,77)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=982.806s, table=77, n_packets=837, n_bytes=82026, idle_age=0, priority=100,ip,reg5=0x2,reg6=0x81,metadata=0x8,nw_src=1.1.1.5 actions=dec_ttl,mod_dl_src:fa:16:3e:d4:60:2d,mod_dl_dst:00:00:00:00:00:00,mod_nw_src:192.168.56.55,load:0x7-&gt;OXM_OF_METADATA[],load:0x84-&gt;NXM_NX_REG6[],resubmit(,55)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=1078.560s, table=55, n_packets=951, n_bytes=92506, idle_age=1, priority=70,metadata=0x7,dl_dst=00:00:00:00:00:00/01:00:00:00:00:00 actions=resubmit(,75)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=1175.212s, table=75, n_packets=1058, n_bytes=102060, idle_age=0, priority=50,metadata=0x7 actions=resubmit(,80)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=1182.328s, table=80, n_packets=1036, n_bytes=101528, idle_age=0, priority=200,metadata=0x7,dl_dst=00:00:00:00:00:00 actions=mod_dl_dst:08:00:27:12:3f:5b,output:1</span><br></pre></td></tr></table></figure></p>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> cookie=0x0, duration=7436.637s, table=0, n_packets=5183, n_bytes=488891, idle_age=0, priority=50,in_port=1,vlan_tci=0x0000/0x1fff actions=load:0-&gt;OXM_OF_IN_PORT[],load:0x7-&gt;OXM_OF_METADATA[],load:0x64-&gt;NXM_NX_REG8[],resubmit(,2)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=7444.618s, table=2, n_packets=4693, n_bytes=459914, idle_age=0, priority=200,ip,reg6=0,nw_src=192.168.56.55 actions=load:0x81-&gt;NXM_NX_REG6[],resubmit(,55)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=7536.097s, table=55, n_packets=4882, n_bytes=481180, idle_age=0, priority=100,metadata=0x7,dl_dst=fa:16:3e:d4:60:2d actions=load:0x84-&gt;NXM_NX_REG7[],resubmit(,75)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=7586.900s, table=75, n_packets=5168, n_bytes=496241, idle_age=0, priority=200,reg7=0x84 actions=resubmit(,76)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=7607.216s, table=76, n_packets=4888, n_bytes=479909, idle_age=0, priority=100,ip,reg7=0x84 actions=dec_ttl,mod_dl_src:fa:16:3e:07:f8:41,mod_dl_dst:fa:16:3e:6c:c0:49,mod_nw_dst:1.1.1.5,load:0x81-&gt;NXM_NX_REG7[],load:0x8-&gt;OXM_OF_METADATA[],resubmit(,55)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=7664.254s, table=55, n_packets=4945, n_bytes=485495, idle_age=0, priority=100,metadata=0x8,dl_dst=fa:16:3e:6c:c0:49 actions=load:0x81-&gt;NXM_NX_REG7[],resubmit(,75)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=7693.739s, table=75, n_packets=4954, n_bytes=485244, idle_age=1, priority=200,reg6=0x81,reg7=0x81 actions=drop 需要将该流表去除，否则ping 自己的fip 不通</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=121.067s, table=75, n_packets=133, n_bytes=13034, idle_age=0, priority=100,reg7=0x81 actions=resubmit(,105)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=147.545s, table=110, n_packets=177, n_bytes=17346, idle_age=0, priority=65534,ct_state=-new+est-rel-inv+trk actions=resubmit(,115)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=154.348s, table=115, n_packets=202, n_bytes=19572, idle_age=0, priority=100,reg7=0x81 actions=output:24</span><br></pre></td></tr></table></figure>
<h1 id="gw-ping-fip"><a href="#gw-ping-fip" class="headerlink" title="gw ping fip"></a>gw ping fip</h1><p><img src="/myimages/3049078FE0BBF02B9150D8948052D805.png" alt="dd.png"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cookie=0x0, duration=42.589s, table=0, n_packets=42, n_bytes=4116, idle_age=0, priority=50,in_port=1,vlan_tci=0x0000/0x1fff actions=load:0-&gt;OXM_OF_IN_PORT[],load:0x7-&gt;OXM_OF_METADATA[],load:0x64-&gt;NXM_NX_REG8[],resubmit(,2)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=52.497s, table=2, n_packets=51, n_bytes=4998, idle_age=0, priority=1 actions=resubmit(,55)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=84.105s, table=55, n_packets=83, n_bytes=8134, idle_age=0, priority=100,metadata=0x7,dl_dst=fa:16:3e:d4:60:2d actions=load:0x84-&gt;NXM_NX_REG7[],resubmit(,75)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=120.791s, table=75, n_packets=120, n_bytes=11760, idle_age=0, priority=200,reg7=0x84 actions=resubmit(,76)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=130.945s, table=76, n_packets=129, n_bytes=12642, idle_age=1, priority=100,ip,reg7=0x84 actions=dec_ttl,mod_dl_src:fa:16:3e:07:f8:41,mod_dl_dst:fa:16:3e:6c:c0:49,mod_nw_dst:1.1.1.5,load:0x81-&gt;NXM_NX_REG7[],load:0x8-&gt;OXM_OF_METADATA[],resubmit(,55)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=426.456s, table=55, n_packets=422, n_bytes=41356, idle_age=0, priority=100,metadata=0x8,dl_dst=fa:16:3e:6c:c0:49 actions=load:0x81-&gt;NXM_NX_REG7[],resubmit(,75)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=441.774s, table=75, n_packets=437, n_bytes=42826, idle_age=0, priority=100,reg7=0x81 actions=resubmit(,105)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=452.940s, table=105, n_packets=448, n_bytes=43904, idle_age=0, priority=100,ip,reg7=0x81 actions=ct(table=110,zone=OXM_OF_METADATA[0..15])</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=462.916s, table=110, n_packets=457, n_bytes=44786, idle_age=0, priority=65534,ct_state=-new+est-rel-inv+trk actions=resubmit(,115)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=469.042s, table=115, n_packets=478, n_bytes=46060, idle_age=0, priority=100,reg7=0x81 actions=output:24</span><br></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"> cookie=0x0, duration=491.468s, table=0, n_packets=501, n_bytes=48258, idle_age=0, priority=100,in_port=24 actions=load:0x81-&gt;NXM_NX_REG6[],load:0x8-&gt;OXM_OF_METADATA[],load:0-&gt;OXM_OF_IN_PORT[],resubmit(,)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=513.855s, table=0, n_packets=523, n_bytes=50414, idle_age=0, priority=1 actions=resubmit(,5)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=526.255s, table=5, n_packets=520, n_bytes=50960, idle_age=0, priority=200,ip,reg6=0x81,dl_src=fa:16:3e:6c:c0:49,nw_src=1.1.1.5 actions=resubmit(,10)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=539.468s, table=10, n_packets=533, n_bytes=52234, idle_age=0, priority=100,ip,reg6=0x81 actions=ct(table=15,zone=OXM_OF_METADATA[0..15])</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=550.488s, table=15, n_packets=543, n_bytes=53214, idle_age=1, priority=65534,ct_state=-new+est-rel-inv+trk actions=resubmit(,20)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=561.685s, table=20, n_packets=555, n_bytes=54390, idle_age=0, priority=1 actions=resubmit(,55)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=622.180s, table=55, n_packets=615, n_bytes=60270, idle_age=0, priority=200,metadata=0x8,dl_dst=fa:16:3e:07:f8:41 actions=load:0x2-&gt;NXM_NX_REG5[],resubmit(,60)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=630.094s, table=60, n_packets=623, n_bytes=61054, idle_age=0, priority=70,ip,reg5=0x2,reg6=0x81,metadata=0x8,nw_src=1.1.1.5 actions=resubmit(,77)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=640.276s, table=77, n_packets=633, n_bytes=62034, idle_age=0, priority=100,ip,reg5=0x2,reg6=0x81,metadata=0x8,nw_src=1.1.1.5 actions=dec_ttl,mod_dl_src:fa:16:3e:d4:60:2d,mod_dl_dst:00:00:00:00:00:00,mod_nw_src:192.168.56.55,load:0x7-&gt;OXM_OF_METADATA[],load:0x84-&gt;NXM_NX_REG6[],resubmit(,55)</span><br><span class="line"></span><br><span class="line">cookie=0x0, duration=675.033s, table=55, n_packets=756, n_bytes=70706, idle_age=0, priority=70,metadata=0x7,dl_dst=00:00:00:00:00:00/01:00:00:00:00:00 actions=resubmit(,75)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=701.542s, table=75, n_packets=694, n_bytes=68012, idle_age=0, priority=50,metadata=0x7 actions=resubmit(,80)</span><br><span class="line"></span><br><span class="line"> cookie=0x0, duration=709.685s, table=80, n_packets=701, n_bytes=68698, idle_age=1, priority=200,metadata=0x7,dl_dst=00:00:00:00:00:00 actions=mod_dl_dst:08:00:27:12:3f:5b,output:1</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/h.jpg"
               alt="vcpu.me" />
          <p class="site-author-name" itemprop="name">vcpu.me</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">83</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">12</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">202</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/vcpu/" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="https://ytlm.github.io/" title="CDN张三丰" target="_blank">CDN张三丰</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://io.iwalk.me" title="互联网绝世高手Andy" target="_blank">互联网绝世高手Andy</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2017 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">vcpu.me</span>
</div>



        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
      <script id="dsq-count-scr" src="https://vcpu.me.disqus.com/count.js" async></script>
    

    

  




	





  





  








  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("l5u4v8AcoPCp9wlPGVJTG6Ny-gzGzoHsz", "RQdYIOd2snvd1muAW65nsn25");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  

</body>
</html>
